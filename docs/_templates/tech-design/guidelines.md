# 技术设计文档写作规范

> 本规范为 `tech-design` 类型专属规范。通用基线规范请参见：
> [`docs/_templates/writing-guidelines.md`](../writing-guidelines.md)

---

## 适用范围

本规范适用于所有 `tech-design` 类型文档，包括但不限于：

- 新系统/服务的架构设计
- 重大功能变更的技术方案
- 架构演进与重构计划
- 技术选型决策文档

技术设计文档是工程师对齐技术方向、驱动代码评审和技术决策的核心文档。**质量标准比速度更重要**——一份含糊不清的设计文档比没有文档危害更大。

---

## 结构要求

### 必需章节

以下章节必须在文档中出现：

1. **执行摘要** —— 独立可读的 3-5 句话概要
2. **背景与问题陈述 > 背景** —— 上下文和触发原因
3. **背景与问题陈述 > 问题陈述** —— 可量化的问题定义
4. **目标与非目标 > 目标** —— SMART 目标列表
5. **目标与非目标 > 非目标** —— 边界界定
6. **架构设计 > 架构总览** —— 含 Mermaid 图的架构说明
7. **架构设计 > 组件清单** —— 所有关键组件表格
8. **安全与隐私考量 > 安全控制措施** —— 不可省略，即使无新增风险
9. **测试策略 > 测试层次** —— 测试覆盖计划
10. **测试策略 > 验收标准** —— 可量化的完成判定条件
11. **风险与缓解** —— 至少识别 3 个主要风险
12. **未指定项与假设清单** —— 所有待确认项的集中跟踪

### 推荐章节顺序

```
1. 执行摘要
2. 背景与问题陈述（背景 → 问题陈述）
3. 目标与非目标（目标 → 非目标）
4. 架构设计（架构总览 → 组件清单 → 数据流与接口定义）
5. 安全与隐私考量（威胁模型 → 安全控制 → 隐私影响）
6. 测试策略（测试层次 → 验收标准）
7. 部署与运维（部署方案 → 可观测性 → 回滚方案）
8. 风险与缓解
9. 里程碑与排期
10. 未指定项与假设清单
11. 附录（参考资料 → 备选方案 → 术语表）
```

---

## 内容规范

### 执行摘要写作原则

执行摘要是最重要的章节，通常由技术 Leader 或非技术决策者最先阅读：

- **长度**：3-5 句话，不超过 150 字
- **结构**：背景问题 → 方案核心思路 → 预期收益/影响
- **避免**：技术细节、专业缩写（不解释的情况下）、"我们将会……"等模糊承诺
- **示例**：
  > 当前订单服务单体架构导致高峰期 P99 延迟超过 2s（目标 200ms）。本方案将订单核心链路拆分为独立微服务，通过异步消息队列解耦，预计将 P99 降至 100ms 以内。改造分三阶段进行，预计 Q2 完成，不影响现有业务接口。

### 问题陈述规范

好的问题陈述必须：

- 使用数据，而非感觉：❌ "系统很慢" → ✅ "P99 延迟达到 2.3s，超过 SLO 目标 200ms 的 11 倍"
- 描述影响范围：受影响的用户数、业务指标、团队效率
- 不包含解决方案：问题陈述只描述"是什么"，不描述"怎么办"

### 目标写作规范

每条目标应满足 SMART 原则：

| 维度 | 要求 | 示例 |
|------|------|------|
| **Specific（具体）** | 明确指向某个指标或能力 | "降低延迟"不够具体 |
| **Measurable（可量化）** | 有具体数值或可验证状态 | "P99 < 200ms" |
| **Achievable（可达成）** | 基于现有资源和时间合理 | 不写超出团队能力的目标 |
| **Relevant（相关）** | 与问题直接对应 | 目标应解决问题陈述中的问题 |
| **Time-bound（有时限）** | 指定完成时间 | "Q2 末完成核心链路改造" |

### 架构图规范

技术设计文档必须包含至少一个 Mermaid 架构图：

**图表选择建议**：

```
flowchart / graph    → 系统组件和依赖关系（首选）
sequenceDiagram      → 关键流程的时序（如登录、支付流程）
C4Context/Container  → 系统边界和外部依赖（C4 模型）
erDiagram            → 数据库表结构关系
stateDiagram         → 状态机和生命周期
```

**图表质量标准**：
- 每个节点有明确的标签（名词短语）
- 连线标注方向和数据/事件名称
- 按层次分组（使用 `subgraph`），不超过 4 层
- 避免节点过多（单图超过 15 个节点时考虑拆分）

**图表后必须有文字说明**，至少覆盖：
1. 图中各层/分区的职责
2. 关键设计决策及选择理由（为什么这样设计，而不是其他方式）

### 组件清单规范

组件表格的每一行必须包含：

| 字段 | 要求 |
|------|------|
| **组件名称** | 使用系统内部的正式名称，保持一致 |
| **职责描述** | 一句话，以动词开头，如"负责 X，提供 Y" |
| **技术选型** | 具体到语言/框架/版本 |
| **依赖组件** | 列出直接依赖，不列传递依赖 |

### 安全章节规范

安全章节是技术评审的重点，**不可因"看起来没有安全问题"而省略**：

- 如果确实无新增安全风险，需明确写："本方案不引入新的安全威胁面，理由如下：……"
- 威胁模型可采用 STRIDE 框架（选做），至少需识别最主要的 2-3 个威胁
- 安全控制措施需覆盖认证、鉴权、传输、数据三个维度

### 风险矩阵规范

风险记录需覆盖三个层面：

1. **技术风险**：技术选型未验证、性能不达标、第三方依赖不稳定
2. **工程风险**：工期估算偏差、依赖团队阻塞、人员变动
3. **业务/组织风险**：需求变更、用户行为假设不成立、合规要求变化

优先级评定：
- **P0**：高可能性 × 高影响，必须有明确缓解措施
- **P1**：中可能性 × 高影响，或高可能性 × 中影响，应有缓解措施
- **P2**：低可能性或低影响，监控即可，暂不需要主动缓解

### 未指定项处理规范

`未指定项与假设清单`章节是本文档的"开放问题追踪器"：

- 每个假设必须标注：若假设不成立，对设计的影响
- 每个待决策项必须给出候选选项，而非空白
- 每个缺失信息必须标注来源（由谁/哪个团队提供）
- 文档提交评审时，P0/P1 优先级的待补充信息应已解决

---

## 语气与风格

### 使用工程师语言

- **精确**：使用准确的技术术语，不用模糊词（"差不多"、"大概"、"可能"）
- **被动改主动**：❌ "数据将被服务处理" → ✅ "服务处理数据"
- **量化结论**：❌ "性能有所提升" → ✅ "P99 延迟从 500ms 降至 80ms（提升 84%）"

### 避免的反模式

| 反模式 | 正确做法 |
|--------|---------|
| 过度设计：列出 10 个可选方案但无结论 | 给出明确推荐，其余放附录作记录 |
| 技术炫耀：堆砌时髦词汇 | 只选用解决实际问题的技术 |
| 假装完整：用空占位符提交 | 未确定的内容放入"未指定项"章节 |
| 忽略非目标：只写做什么 | 非目标与目标同等篇幅、同等重视 |
| 省略备选方案：只写最终方案 | 在附录记录已评估的其他方案 |

---

## 评审清单

提交技术设计文档前，核对以下项目：

### 完整性检查

- [ ] **执行摘要**可独立阅读，无须看正文也能理解核心方案
- [ ] **问题陈述**有数据支撑，不是主观感受
- [ ] **目标**条目可量化，**非目标**明确列出至少 2 项
- [ ] **架构图**已包含 Mermaid 图，节点有标签，连线有方向
- [ ] **组件清单**覆盖所有关键组件，每行有技术选型
- [ ] **安全章节**已填写，即使无新增风险也有明确说明
- [ ] **验收标准**条目可验证，有具体数值或行为描述
- [ ] **风险表**至少 3 项，覆盖技术、工程、业务三个层面
- [ ] **未指定项与假设清单**无遗漏，P0 优先级项已处理

### 质量检查

- [ ] 无遗留占位符（`{...}` 或 `<!-- -->`）
- [ ] 所有 Mermaid 代码块可正常渲染（无语法错误）
- [ ] 表格列对齐，无空行破坏格式
- [ ] 中英文混排遵循通用基线规范
- [ ] 技术术语在首次出现时解释或添加术语表条目
- [ ] 跨章节引用一致（组件名称、指标单位前后统一）

### 评审就绪检查

- [ ] 已与主要依赖团队沟通对齐，不存在"评审后才发现的依赖"
- [ ] 附录中已记录主要备选方案及放弃理由
- [ ] 文档状态已更新为"评审中"
- [ ] 评审人已在文档头部填写
