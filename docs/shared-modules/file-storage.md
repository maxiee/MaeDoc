# 文件存储系统

> **文档类型**：技术方案设计
> **来源**：从 [跨平台个人生产力系统技术概览](../cross-platform-setup/personal-productivity-system-overview.md) 拆分
> **日期**：2026-02-20

---

文件存储系统是整个基础设施的底层支撑。它采用 **UUID 分层存储 + Sidecar 元信息**的架构，实现文件名与语义的解耦。

---

## 3.1 核心设计思想

传统文件系统的痛点：

- **文件名承载语义**：重命名会破坏链接、引用和关联关系
- **元信息分散**：EXIF、PDF 元数据、自定义标签等散落在各处，难以统一查询
- **跨应用互通困难**：每个应用维护自己的"库"索引，互不兼容

本系统的解决方案：

- **文件名语义无关**：所有文件以 UUID 命名，语义信息全部外置到 Sidecar 文件
- **统一的元信息层**：Sidecar 文件采用 Markdown 格式，包含结构化 frontmatter 和自由格式的正文
- **数据库镜像**：Sidecar 中的结构化信息自动同步到 SQLite 数据库，支持高效查询

---

## 3.2 文件路径生成规则

UUID 采用 v4（随机）版本，格式为 36 字符（32 位十六进制 + 4 个连字符）。

**分层映射规则**：将 UUID 的前 4 个字符作为目录层级，实现均匀分布。

```
原始 UUID：a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf
存储路径：storage/a1/b2/c3/a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf
Sidecar： storage/a1/b2/c3/a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf.meta.md
```

**优点**：

- 避免单目录文件数过多（文件系统性能考虑）
- 支持任意深度的文件树逻辑结构（通过数据库关联实现）
- 重命名、移动操作只涉及数据库更新，不涉及物理文件移动

---

## 3.3 Sidecar 文件格式

Sidecar 文件与原始文件同名，追加 `.meta.md` 后缀。格式为 **YAML frontmatter + Markdown 正文**。

```markdown
---
# 结构化元信息（自动同步到数据库）
uuid: a1b2c3d4-e5f6-7890-abcd-ef1234567890
original_name: 项目计划书.pdf
mime_type: application/pdf
size_bytes: 1048576
created_at: 2026-02-20T10:00:00Z
modified_at: 2026-02-20T15:30:00Z
tags:
  - 工作
  - 项目A
  - 2026Q1
entities:
  - type: project
    name: 项目A
  - type: person
    name: 张三
custom_fields:
  priority: high
  status: draft
---

# 自由格式笔记

这是项目A的计划书初稿，需要在本周五前完成评审。

## 待办

- [ ] 补充预算明细
- [ ] 确认技术方案
- [ ] 发送给李四审核
```

**设计考量**：

- **人类可读可编辑**：用户可以直接编辑 Sidecar 文件，修改会被同步到数据库
- **版本控制友好**：Markdown 格式适合 git diff
- **扩展性强**：`custom_fields` 支持任意键值对，无需修改 Schema

---

## 3.4 文件操作流程

**创建文件**：

1. 用户或 AI Agent 提交文件内容 + 初始元信息
2. 系统生成 UUID，计算存储路径
3. 写入原始文件，创建 Sidecar 文件
4. 触发同步任务，将 frontmatter 解析并写入数据库

**重命名/移动**：

1. 用户请求将文件从"旧显示名"改为"新显示名"
2. 系统只更新数据库中的 `original_name` 字段和 Sidecar 文件
3. 物理文件路径不变（仍是 UUID 路径）
4. UI 层显示新名称，底层关联关系完整保留

**删除**：

1. 标记为"已删除"（软删除），保留 Sidecar
2. 可选：移动到 `.trash/` 目录
3. 定期清理任务永久删除（可配置保留时长）

---

## 3.5 并发与冲突处理

**写入锁**：使用文件系统级别的锁（`flock` / `LockFileEx`），确保同一文件的并发写入串行化。

**冲突检测**：Sidecar 文件包含 `version` 字段，每次更新递增。写入时检查版本号，若版本不匹配则拒绝写入，提示用户合并。

**冲突解决策略**：

- 自动合并：对于非冲突字段（如 tags 新增），自动合并
- 人工干预：对于冲突字段（如 `original_name` 改为不同值），保留两份，提示用户选择

---

*本文档是跨平台个人生产力系统设计系列的一部分。其他相关文档：[数据库系统](./database.md)、[系统概述](../system-design/overview.md)*
