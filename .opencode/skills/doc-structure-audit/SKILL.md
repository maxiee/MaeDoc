---
name: doc-structure-audit
description: 检查文档是否符合其文档类型定义的结构要求，包括必需章节存在性、章节顺序、断链检测、重复内容检测，输出结构审计报告（缺失项 + 问题定位 + 修复建议）
---

# doc-structure-audit

> **Skill ID**：`doc-structure-audit`
> **版本**：1.0.0
> **类型**：instruction
> **用途**：检查文档是否符合其文档类型定义的结构要求，输出审计报告

---

## 触发条件

当用户说出以下类似意图时，激活本 Skill：

- "检查这篇文档的结构是否完整"
- "审计这个文档是否符合模板要求"
- "帮我检查文档结构"
- "这篇技术设计文档缺少哪些章节"
- "audit 一下这个文档的结构"
- 或由 `/review`、`/audit` 命令内部调用

---

## 输入

本 Skill 需要以下信息（如未提供，按照"缺失信息处理"步骤主动收集）：

| 参数 | 必需 | 说明 |
|------|:----:|------|
| `document` | 是 | 待审计的文档内容或文件路径 |
| `doc_type` | 否 | 文档类型（`type_id`），如 `tech-design`、`blog-post`；未指定则尝试自动推断 |
| `strict_mode` | 否 | 严格模式：`true` 时章节顺序不符视为错误，`false`（默认）时仅报告顺序偏差 |

---

## 执行步骤

### 步骤 1：加载文档类型定义

1. 读取目标文档内容，提取所有标题（H1、H2、H3）构建**实际章节树**
2. 确定文档类型：
   - 若提供了 `doc_type`，读取 `docs/_templates/{type_id}/type.json`
   - 若未提供，尝试从文档内容（标题结构、关键词）推断类型，并列出推断依据
   - 若无法推断，提示用户指定 `doc_type`，并列出可用类型（扫描 `docs/_templates/*/type.json`）
3. 从 `type.json` 提取**期望章节树**：
   - 必需章节（`required: true`）
   - 可选章节（`required: false`）
   - 子章节定义（`subsections`）
   - 期望顺序（`sections` 数组顺序即为期望顺序）

### 步骤 2：必需章节存在性检查

对 `type.json` 中每个 `required: true` 的章节：

1. 在实际章节树中查找匹配项（按章节标题或 `id` 匹配，允许小幅措辞变化）
2. **精确匹配**：章节标题与定义完全一致 → 标记为 ✅ 存在
3. **模糊匹配**：标题措辞有差异但语义相同 → 标记为 ⚠️ 疑似匹配，列出匹配依据，需用户确认
4. **未找到**：章节不存在 → 标记为 ❌ 缺失，记录到缺失清单

对 `required: false` 的可选章节，记录是否存在，不计入错误。

### 步骤 3：章节顺序检查

1. 提取实际文档中**已识别**章节（无论必需还是可选）的出现顺序
2. 与 `type.json` 中 `sections` 定义的期望顺序对比
3. 识别顺序偏差：
   - 某章节出现在预期位置之前 → 记录「顺序超前」
   - 某章节出现在预期位置之后 → 记录「顺序滞后」
4. 根据 `strict_mode` 决定严重程度：
   - `strict_mode: true`：顺序偏差标记为 ❌ 错误
   - `strict_mode: false`（默认）：顺序偏差标记为 ⚠️ 警告

### 步骤 4：断链检测

检查文档内部引用的完整性：

1. **内部锚点链接**：提取所有 `[文本](#anchor)` 形式的链接，检查目标锚点（对应标题）是否存在于文档中
2. **文件引用**：提取文档中引用的本地文件路径（`[文本](./path/to/file.md)` 等），检查文件是否存在
3. **图片引用**：提取所有 `![alt](path)` 图片引用，检查图片文件是否存在
4. **未定义引用**：识别文档中使用了 `[文本][ref]` 形式但 `[ref]:` 未在文档底部定义的引用
5. 每个断链记录：引用位置（行号/章节）、原始链接内容、断链类型

### 步骤 5：重复内容检测

1. **重复章节标题**：检查是否有两个或多个章节使用了相同或高度相似的标题
2. **重复段落**：识别完全相同或高度重叠（>80% 相似度）的段落块
3. **重复定义**：检查同一术语或概念是否在多个章节中给出了不同的（可能矛盾的）定义
4. 对每处重复，记录：涉及章节、重复内容摘要、建议处理方式（合并/删除/区分）

### 步骤 6：生成审计报告

1. 汇总所有发现，按严重程度分级：
   - **❌ 错误（Error）**：必需章节缺失、`strict_mode` 下的顺序错误、断链
   - **⚠️ 警告（Warning）**：顺序偏差（非严格模式）、疑似匹配章节、重复内容
   - **ℹ️ 提示（Info）**：可选章节缺失、格式建议
2. 计算结构合规评分：`（存在的必需章节数 / 总必需章节数） × 100%`
3. 为每个问题生成具体的修复建议

---

## 输出格式

```markdown
# 文档结构审计报告

> **审计文档**：{文档标题或文件路径}
> **审计时间**：{当前日期}
> **文档类型**：{type_id}（{文档类型名称}）
> **严格模式**：{开启 / 关闭}
> **结构合规率**：{N}%（{存在必需章节数}/{总必需章节数} 个必需章节存在）

---

## 审计概览

| 检查项 | 错误 | 警告 | 提示 |
|--------|:----:|:----:|:----:|
| 必需章节存在性 | {N} | {N} | — |
| 章节顺序 | {N} | {N} | — |
| 断链检测 | {N} | — | {N} |
| 重复内容 | — | {N} | {N} |
| **合计** | **{N}** | **{N}** | **{N}** |

{若无任何问题：}
> ✅ 文档结构完全符合 `{type_id}` 类型定义，无需修改。

---

## 必需章节检查

| 序号 | 章节 ID | 期望标题 | 实际状态 | 文档位置 |
|------|---------|---------|---------|---------|
| 1 | `{id}` | {期望标题} | ✅ 存在 | 第 {行号} 行 |
| 2 | `{id}` | {期望标题} | ⚠️ 疑似匹配 | 第 {行号} 行（实际标题：{实际标题}） |
| 3 | `{id}` | {期望标题} | ❌ 缺失 | — |

### 缺失章节修复建议

**章节：{缺失章节标题}**
- 应插入位置：在「{前一章节}」之后
- 建议内容框架：{根据类型定义中的 description 给出内容提示}

---

## 章节顺序检查

{若顺序完全正确：}
> ✅ 章节顺序与类型定义完全一致。

{若存在顺序偏差：}

| 章节 | 期望位置 | 实际位置 | 偏差类型 | 严重程度 |
|------|---------|---------|---------|---------|
| {章节标题} | 第 {N} 位 | 第 {N} 位 | 顺序超前/滞后 | ❌ 错误 / ⚠️ 警告 |

**修复建议**：将「{章节标题}」移至「{前置章节}」之后。

---

## 断链检测

{若无断链：}
> ✅ 未发现断链问题。

{若存在断链：}

| # | 断链位置 | 原始引用 | 断链类型 | 修复建议 |
|---|---------|---------|---------|---------|
| 1 | 第 {行号} 行 / 「{章节名}」 | `{原始链接内容}` | 内部锚点 / 文件引用 / 图片 / 未定义引用 | {具体修复建议} |

---

## 重复内容检测

{若无重复：}
> ✅ 未发现重复内容问题。

{若存在重复：}

### ⚠️ 重复章节标题

- 「{标题}」出现于第 {行号} 行和第 {行号} 行 → 建议区分章节用途或合并

### ⚠️ 重复段落

- 第 {行号}–{行号} 行与第 {行号}–{行号} 行内容高度重叠（相似度 ~{N}%）
  - 摘要：「{内容摘要}」
  - 建议：保留 {位置A}，删除 {位置B}；或提取为独立引用段落

### ⚠️ 重复定义

- 术语「{术语}」在「{章节 A}」和「{章节 B}」中有不同表述：
  - {章节 A}：「{定义 A}」
  - {章节 B}：「{定义 B}」
  - 建议：统一至 {建议保留版本}，并在其他章节引用

---

## 可选章节状态

| 章节 | 状态 | 备注 |
|------|:----:|------|
| {可选章节标题} | ✅ 已包含 | — |
| {可选章节标题} | ℹ️ 未包含 | 适用于 {使用场景} |

---

## 汇总修复清单

按优先级排序的修复行动项：

1. **[错误]** 添加缺失的必需章节：{章节列表}
2. **[错误]** 修复断链：{链接列表}
3. **[警告]** 调整章节顺序：{章节列表}
4. **[警告]** 处理重复内容：{位置列表}

---

*如需填充缺失章节内容，可使用 `doc-content-fill` Skill。*
*如需全面内容审阅，可使用 `doc-review` Skill。*
```

---

## 缺失信息处理

| 场景 | 处理方式 |
|------|---------|
| 文档未提供 | 请求用户提供文档内容或文件路径，不可继续 |
| `doc_type` 未指定且无法推断 | 列出所有可用文档类型（扫描 `docs/_templates/*/type.json`），请用户选择后继续 |
| `type.json` 文件不存在 | 提示"无法找到类型定义文件 `docs/_templates/{type_id}/type.json`"，列出实际存在的类型 |
| 文档不是 Markdown 格式 | 提示"本 Skill 仅支持 Markdown 格式文档"，终止执行 |
| 文档内容为空 | 报告"文档为空，所有必需章节均缺失"，列出需要创建的章节清单 |

---

## 注意事项

1. **标题匹配容忍度**：章节标题匹配时允许合理的措辞变化（如"执行摘要"与"Executive Summary"视为同一章节），但需在报告中注明匹配依据，并标记为"疑似匹配"等待用户确认
2. **子章节处理**：仅当 `type.json` 中定义了 `subsections` 时才检查子章节结构；未定义子章节时不对 H3 级标题做结构约束
3. **断链外部 URL 豁免**：外部 HTTP/HTTPS 链接不做可达性检查（避免网络依赖），仅做格式合法性检查
4. **重复检测阈值**：段落相似度超过 80% 才报告，避免正常的术语复用产生误报；代码块内容不做重复检测
5. **只审计，不修改**：本 Skill 不直接修改文档内容；若需修复，在报告末尾引导用户使用对应 Skill

---

## 质量标准

审计报告应满足：

- [ ] 所有必需章节均逐一列出检查结果（无遗漏）
- [ ] 每个缺失章节均有明确的插入位置建议
- [ ] 断链问题均有精确行号定位
- [ ] 重复内容均有具体的两处位置标注
- [ ] 结构合规率计算正确（基于必需章节）
- [ ] 修复清单按错误 → 警告 → 提示顺序排列，优先级清晰

---

## 示例

**用户输入**：
> 帮我审计这篇文档的结构（提供一篇技术设计文档，但缺少"测试策略"章节，且"风险与缓解"章节出现在"里程碑"之后）

**Skill 行为**：
1. 读取文档，提取实际章节树
2. 加载 `docs/_templates/tech-design/type.json`，获取 12 个章节定义（其中 10 个必需）
3. 必需章节检查：9/10 章节存在，"测试策略"缺失 → 记录为 ❌ 错误，建议插入位置
4. 章节顺序检查：发现"风险与缓解"（期望第 10 位）出现在第 11 位，"里程碑"（期望第 11 位）出现在第 10 位 → 严格模式关闭，记录为 ⚠️ 警告
5. 断链检测：发现 1 处内部锚点 `#architecture-diagram` 无对应标题 → 记录为 ❌ 错误
6. 重复内容检测：未发现重复问题
7. 输出报告：结构合规率 90%，2 个错误（章节缺失 + 断链）、1 个警告（章节顺序）
