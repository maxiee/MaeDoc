---
name: doc-structure-audit
description: 检查文档的结构完整性，包括标题层级、断链检测、重复内容检测，以及 docs/ 目录级别的结构合规检查（行数限制、index.md 导航规范、未注册文档），输出结构审计报告（问题定位 + 修复建议）
---

# doc-structure-audit

> **Skill ID**：`doc-structure-audit`
> **版本**：1.1.0
> **类型**：instruction
> **用途**：检查文档结构完整性，以及 docs/ 目录是否遵循 `maedoc/docs-structure-standard.md` 定义的结构标准，输出审计报告

---

## 触发条件

当用户说出以下类似意图时，激活本 Skill：

- "检查这篇文档的结构是否完整"
- "审计这个文档是否符合模板要求"
- "帮我检查文档结构"
- "这篇技术设计文档缺少哪些章节"
- "audit 一下这个文档的结构"
- "检查 docs/ 目录结构是否合规"
- 或由 `/review`、`/audit` 命令内部调用

---

## 输入

本 Skill 需要以下信息（如未提供，按照"缺失信息处理"步骤主动收集）：

| 参数 | 必需 | 说明 |
|------|:----:|------|
| `document` | 是* | 待审计的文档内容或文件路径；若 `audit_scope = docs_dir` 则不需要 |
| `strict_mode` | 否 | 严格模式：`true` 时章节顺序不符视为错误，`false`（默认）时仅报告顺序偏差 |
| `audit_scope` | 否 | 审计范围：`single_doc`（默认，审计单文档）/ `docs_dir`（审计整个 docs/ 目录结构） |

---

## 执行步骤

### 步骤 0：确定审计范围

根据 `audit_scope` 参数路由：

- `audit_scope = docs_dir`：执行 **步骤 0.5（docs/ 目录结构审计）**，跳过步骤 1-5
- `audit_scope = single_doc`（默认）：跳过步骤 0.5，直接执行步骤 1-6

---

### 步骤 0.5：docs/ 目录结构审计（`audit_scope = docs_dir` 时执行）

> **标准依据**：`maedoc/docs-structure-standard.md`

扫描 `docs/` 目录下所有 `.md` 文件，检查以下违规项：

**检查项 A：行数限制（标准 §3）**

1. 统计每个 `.md` 文件的行数
2. 行数 > 330（即超过 300 行 ±10% 弹性上限）→ **❌ 错误**：超长文档
3. 行数 280-330 → **⚠️ 警告**：接近上限，建议关注

**检查项 B：index.md 存在性与导航规范（标准 §2）**

1. `docs/index.md` 是否存在 → 不存在 **❌ 错误**
2. 每个子目录（`docs/{topic}/`）是否有 `index.md` → 缺少 **❌ 错误**
3. `docs/index.md` 中是否有"文档地图"章节（`## 文档地图` 或 `## 文档目录`）→ 缺少 **⚠️ 警告**
4. `docs/index.md` 的行数是否超过 150 行 → **⚠️ 警告**（导航文档偏重）

**检查项 C：未注册文档（标准 §1）**

1. 扫描 `docs/` 下所有 `.md` 文件（排除 `_archive/`、`TODO.md`）
2. 检查每个文件或其父目录的 index.md 是否被 `docs/index.md` 引用
3. 未被引用的文档 → **⚠️ 警告**：未注册文档（"孤立文档"）

**输出格式**（docs 目录结构审计报告）：

```markdown
# docs/ 目录结构审计报告

> **审计标准**：`maedoc/docs-structure-standard.md`
> **审计时间**：{当前日期}
> **扫描文档数**：{N} 篇

## 审计概览

| 检查项 | 错误 | 警告 |
|--------|:----:|:----:|
| 行数超限（>300行） | {N} | {N} |
| index.md 存在性与导航规范 | {N} | {N} |
| 未注册文档 | — | {N} |
| **合计** | **{N}** | **{N}** |

## 超长文档

| 文件 | 行数 | 状态 | 修复建议 |
|------|------|:----:|---------|
| `{path}` | {N} | ❌ 超限 / ⚠️ 接近 | 使用 `/evolve` 拆分 |

## index.md 问题

| 问题 | 位置 | 严重程度 |
|------|------|:-------:|
| {描述} | {路径} | ❌ / ⚠️ |

## 未注册文档（未出现在 docs/index.md 中）

| 文件 | 状态 |
|------|------|
| `{path}` | ⚠️ 未注册 |

## 修复建议

1. **[错误]** {具体操作}
2. **[警告]** {具体操作}
```

生成报告后，若无错误则输出：`✅ docs/ 目录结构符合标准，无违规项。`

**此步骤完成后，跳过步骤 1-3，直接执行步骤 4（生成汇总修复清单）。**

---

### 步骤 1：加载文档与分析结构

1. 读取目标文档内容，提取所有标题（H1、H2、H3）构建**实际章节树**
2. 检查标题层级是否合规（H1 唯一、H2→H3 不跳级）
3. 检查是否存在空章节（有标题但无实质内容）

### 步骤 2：断链检测

检查文档内部引用的完整性：

1. **内部锚点链接**：提取所有 `[文本](#anchor)` 形式的链接，检查目标锚点（对应标题）是否存在于文档中
2. **文件引用**：提取文档中引用的本地文件路径（`[文本](./path/to/file.md)` 等），检查文件是否存在
3. **图片引用**：提取所有 `![alt](path)` 图片引用，检查图片文件是否存在
4. **未定义引用**：识别文档中使用了 `[文本][ref]` 形式但 `[ref]:` 未在文档底部定义的引用
5. 每个断链记录：引用位置（行号/章节）、原始链接内容、断链类型

### 步骤 3：重复内容检测

1. **重复章节标题**：检查是否有两个或多个章节使用了相同或高度相似的标题
2. **重复段落**：识别完全相同或高度重叠（>80% 相似度）的段落块
3. **重复定义**：检查同一术语或概念是否在多个章节中给出了不同的（可能矛盾的）定义
4. 对每处重复，记录：涉及章节、重复内容摘要、建议处理方式（合并/删除/区分）

### 步骤 4：生成审计报告

1. 汇总所有发现，按严重程度分级：
   - **❌ 错误（Error）**：断链、标题层级问题
   - **⚠️ 警告（Warning）**：重复内容、空章节
   - **ℹ️ 提示（Info）**：格式建议
2. 为每个问题生成具体的修复建议

---

## 输出格式

```markdown
# 文档结构审计报告

> **审计文档**：{文档标题或文件路径}
> **审计时间**：{当前日期}
> **严格模式**：{开启 / 关闭}

---

## 审计概览

| 检查项 | 错误 | 警告 | 提示 |
|--------|:----:|:----:|:----:|
| 标题层级 | {N} | — | — |
| 断链检测 | {N} | — | {N} |
| 重复内容 | — | {N} | {N} |
| **合计** | **{N}** | **{N}** | **{N}** |

{若无任何问题：}
> ✅ 文档结构无问题，无需修改。

---

## 断链检测

{若无断链：}
> ✅ 未发现断链问题。

{若存在断链：}

| # | 断链位置 | 原始引用 | 断链类型 | 修复建议 |
|---|---------|---------|---------|---------|
| 1 | 第 {行号} 行 / 「{章节名}」 | `{原始链接内容}` | 内部锚点 / 文件引用 / 图片 / 未定义引用 | {具体修复建议} |

---

## 重复内容检测

{若无重复：}
> ✅ 未发现重复内容问题。

{若存在重复：}

### ⚠️ 重复章节标题

- 「{标题}」出现于第 {行号} 行和第 {行号} 行 → 建议区分章节用途或合并

### ⚠️ 重复段落

- 第 {行号}–{行号} 行与第 {行号}–{行号} 行内容高度重叠（相似度 ~{N}%）
  - 摘要：「{内容摘要}」
  - 建议：保留 {位置A}，删除 {位置B}；或提取为独立引用段落

### ⚠️ 重复定义

- 术语「{术语}」在「{章节 A}」和「{章节 B}」中有不同表述：
  - {章节 A}：「{定义 A}」
  - {章节 B}：「{定义 B}」
  - 建议：统一至 {建议保留版本}，并在其他章节引用

---

## 汇总修复清单

按优先级排序的修复行动项：

1. **[错误]** 修复断链：{链接列表}
2. **[警告]** 处理重复内容：{位置列表}

---

*如需填充内容，可使用 `doc-content-fill` Skill。*
*如需全面内容审阅，可使用 `doc-review` Skill。*
```

---

## 缺失信息处理

> **交互原则**：所有需要向用户提问的情况，**必须使用 `question` 工具**进行交互，不得直接输出文本等待用户回复。

| 场景 | 处理方式 |
|------|---------|
| 文档未提供 | 使用 `question` 工具请求用户提供文档内容或文件路径，不可继续 |
| 文档不是 Markdown 格式 | 提示"本 Skill 仅支持 Markdown 格式文档"，终止执行 |
| 文档内容为空 | 报告"文档为空，无实质内容可审计" |

---

## 注意事项

1. **断链外部 URL 豁免**：外部 HTTP/HTTPS 链接不做可达性检查（避免网络依赖），仅做格式合法性检查
2. **重复检测阈值**：段落相似度超过 80% 才报告，避免正常的术语复用产生误报；代码块内容不做重复检测
3. **只审计，不修改**：本 Skill 不直接修改文档内容；若需修复，在报告末尾引导用户使用对应 Skill

---

## 质量标准

审计报告应满足：

- [ ] 断链问题均有精确行号定位
- [ ] 重复内容均有具体的两处位置标注
- [ ] 修复清单按错误 → 警告 → 提示顺序排列，优先级清晰

---

## 示例

**用户输入**：
> 帮我审计这篇文档的结构

**Skill 行为**：
1. 读取文档，提取实际章节树
2. 检查标题层级：无跳级问题
3. 断链检测：发现 1 处内部锚点 `#architecture-diagram` 无对应标题 → 记录为 ❌ 错误
4. 重复内容检测：未发现重复问题
5. 输出报告：1 个错误（断链）
