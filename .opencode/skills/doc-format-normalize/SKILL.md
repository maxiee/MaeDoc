---
name: doc-format-normalize
description: 检查并修正 Markdown 文档的格式问题，包括标题层级、列表格式、代码块语言标注、表格对齐、空行规范，输出格式化后的文档 diff
---

# doc-format-normalize

> **Skill ID**：`doc-format-normalize`
> **版本**：1.0.0
> **类型**：instruction
> **用途**：统一文档的 Markdown 格式，消除格式不一致，输出格式化后的 diff

---

## 触发条件

当用户说出以下类似意图时，激活本 Skill：

- "帮我格式化这篇文档"
- "统一一下文档的格式"
- "修正文档的 Markdown 格式"
- "normalize 一下这个文档"
- "检查文档格式是否规范"
- 或由 `/create`、`/audit` 命令内部调用

---

## 输入

本 Skill 需要以下信息（如未提供，按照"缺失信息处理"步骤主动收集）：

| 参数 | 必需 | 说明 |
|------|:----:|------|
| `document` | 是 | 待格式化的文档内容或文件路径 |
| `dry_run` | 否 | 是否仅输出 diff 而不修改文件；默认 `true`（仅预览），传入 `false` 时写回文件 |
| `rules` | 否 | 指定只检查哪些规则（如 `headings,code-blocks`）；未指定则检查全部规则 |

---

## 格式规则清单

本 Skill 检查并修正以下六类格式问题：

### 规则 1：标题层级（`headings`）

- **H1 唯一性**：文档中 `# 标题` 有且仅有一个，位于文档首部
- **层级不跳跃**：从 H1 直接跳到 H3（`###`）而跳过 H2 的情况需要修正
- **ATX 风格统一**：统一使用 `#` 式标题，不使用 `===` / `---` 下划线式标题
- **标题与正文间距**：标题前后各保留一个空行（文档首行标题前不加空行）
- **标题末尾无标点**：标题行末尾不加句号、冒号等标点

### 规则 2：列表格式（`lists`）

- **无序列表标记统一**：统一使用 `-` 作为无序列表标记，不混用 `*` 或 `+`
- **有序列表编号**：有序列表使用 `1.` 递增编号，不使用 `a.`、`i.` 等
- **列表缩进**：子列表缩进 2 个空格（不使用 tab）
- **列表项末尾标点**：同一列表内末尾标点风格一致（全部有句号或全部无句号）
- **列表前后空行**：列表块前后各保留一个空行

### 规则 3：代码块语言标注（`code-blocks`）

- **语言标注必填**：所有 ` ``` ` 围栏代码块必须标注语言（如 ` ```python `、` ```json `）
- **常见语言标识规范化**：统一使用小写标识（`JavaScript` → `javascript`，`YAML` → `yaml`）
- **行内代码不替换**：反引号包裹的行内代码（` `` `code` `` `）不做语言标注处理
- **代码块前后空行**：代码块前后各保留一个空行

### 规则 4：表格对齐（`tables`）

- **列分隔符对齐**：表格各行的 `|` 字符在同一列对齐（使用空格补齐）
- **分隔行规范**：表头与表体之间的分隔行（`|---|---|`）至少 3 个 `-`
- **对齐标记统一**：`:---` 左对齐、`:---:` 居中对齐、`---:` 右对齐，不混用
- **表格前后空行**：表格前后各保留一个空行
- **无多余尾随空格**：表格每行末尾无多余空格

### 规则 5：空行规范（`blank-lines`）

- **连续空行压缩**：不允许连续出现超过 1 个空行（压缩为 1 个）
- **文件末尾换行**：文件最后一行为单个换行符（无多余空行，有且仅有一个 `\n`）
- **章节间距**：H2/H3 标题前保留 1 个空行（已由规则 1 覆盖）
- **段落间距**：段落之间保留 1 个空行，不允许无空行直接连接两段正文

### 规则 6：行内格式（`inline`）

- **尾随空格清除**：每行行尾无多余空格
- **中英文混排空格**：中文与英文字母/数字之间加一个空格（如 `使用 Python 开发` 而非 `使用Python开发`）
- **中文与全角符号**：中文文档中使用全角标点（`。，、；：""（）`），不混用半角英文标点（`, . ; : " ( )`）；代码片段除外
- **加粗/斜体配对**：`**` 和 `*` 标记必须成对出现，不允许未闭合的强调标记

---

## 执行步骤

### 步骤 1：读取文档

1. 读取目标文档内容（文本形式）
2. 若文档为文件路径，读取文件；若为直接粘贴内容，直接处理
3. 记录原始内容（用于最终生成 diff）

### 步骤 2：逐规则扫描

按以下顺序依次扫描文档（若 `rules` 参数指定了子集，只运行对应规则）：

1. `headings`：扫描所有标题行，记录层级结构和格式问题
2. `lists`：扫描所有列表块，记录标记不一致和缩进问题
3. `code-blocks`：扫描所有围栏代码块，记录缺失或不规范的语言标注
4. `tables`：扫描所有表格，记录对齐和分隔行问题
5. `blank-lines`：扫描全文空行分布，记录连续空行和文件末尾问题
6. `inline`：扫描行内格式，记录尾随空格和中英文混排问题

每条问题记录：
- 行号
- 规则 ID
- 问题描述
- 原文内容
- 建议修正内容

### 步骤 3：生成修正版本

1. 按照记录的问题，从上到下依次应用修正（先处理行号较小的问题）
2. 注意：修正一处后，后续行号可能偏移，应动态更新行号索引
3. 生成修正后的完整文档内容

### 步骤 4：生成 diff 并输出

1. 对比原始内容与修正内容，生成 unified diff 格式（`--- original` / `+++ formatted`）
2. 统计变更汇总：各规则命中数量、总修改行数
3. 若 `dry_run = true`（默认）：只输出报告和 diff，不修改文件
4. 若 `dry_run = false`：将修正内容写回原文件，并输出报告和 diff

---

## 输出格式

```markdown
# 格式规范化报告

> **处理文档**：{文档标题或文件路径}
> **处理时间**：{当前日期}
> **模式**：{预览模式（dry-run）/ 写入模式}
> **检查规则**：{全部 / 指定规则列表}

---

## 变更汇总

| 规则 | 问题数 | 已修正 |
|------|:------:|:------:|
| 标题层级（headings） | {N} | {N} |
| 列表格式（lists） | {N} | {N} |
| 代码块语言标注（code-blocks） | {N} | {N} |
| 表格对齐（tables） | {N} | {N} |
| 空行规范（blank-lines） | {N} | {N} |
| 行内格式（inline） | {N} | {N} |
| **合计** | **{N}** | **{N}** |

{若无任何问题：> ✅ 文档格式已符合规范，无需修改。}

---

## 问题明细

### 标题层级

- 第 {行号} 行：{问题描述}（原文：`{原内容}`→修正：`{新内容}`）

### 列表格式

- 第 {行号} 行：{问题描述}

...（各规则依次列出）

---

## 格式 Diff

```diff
--- original
+++ formatted
@@ -{行号},{行数} +{行号},{行数} @@
 {上下文行}
-{删除行}
+{新增行}
 {上下文行}
```

---

{若 dry_run = false：}
> ✅ 已将修正内容写回文件：`{文件路径}`
{若 dry_run = true：}
> ℹ️ 预览模式：上述修改**未写入**文件。如需应用修改，请重新调用并传入 `dry_run: false`。
```

---

## 缺失信息处理

| 场景 | 处理方式 |
|------|---------|
| 文档未提供 | 请求用户提供文档内容或文件路径，不可继续 |
| 文档不是 Markdown 格式 | 提示"本 Skill 仅支持 Markdown 格式文档"，终止执行 |
| 文档内容为空 | 报告"文档为空，无需格式化"，终止执行 |
| 指定规则不存在 | 列出合法规则 ID，请用户重新指定 |

---

## 注意事项

1. **只修改格式，不改写内容**：本 Skill 不得修改文档的文字内容、术语、数据或结构；若发现内容问题，在报告末尾用"内容问题提示"单独列出，建议用户使用 `doc-review` 或 `doc-iterate` 处理
2. **代码块内容豁免**：代码块（围栏内）中的内容不应用任何格式规则（代码本身的格式由编程语言规范决定）
3. **最小修改原则**：只修正确实违反规则的地方，不对符合规范的内容做"优化性"修改
4. **中英文混排空格为建议项**：若文档整体风格一致地未使用中英文间距，在报告中说明但不强制修改（标记为 P2 建议）

---

## 质量标准

格式化报告应满足：

- [ ] 所有问题均有精确行号定位
- [ ] Diff 格式标准、可读，上下文行数不少于 2 行
- [ ] 变更汇总数据与问题明细一致
- [ ] 代码块内部内容未被修改
- [ ] 纯格式修改，零内容损失

---

## 示例

**用户输入**：
> 帮我格式化这篇文档（提供一篇混用 `*` 和 `-` 列表标记、代码块无语言标注、标题层级跳跃的 Markdown 文档）

**Skill 行为**：
1. 读取文档内容，记录原始版本
2. 扫描 `headings`：发现第 15 行从 H1 直接跳到 H3，缺少 H2 层级 → 记录问题（需人工确认正确层级，不自动修正，标记为提示）
3. 扫描 `lists`：发现第 23、27、31 行使用 `*` 标记，统一修改为 `-`
4. 扫描 `code-blocks`：发现第 42 行代码块未标注语言 → 根据代码内容推断为 `python` 并标注
5. 扫描 `blank-lines`：发现第 55-57 行连续 3 个空行，压缩为 1 个
6. 生成 diff，输出报告：3 项已修正，1 项（标题层级跳跃）需人工确认
