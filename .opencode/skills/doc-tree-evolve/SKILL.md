---
name: doc-tree-evolve
description: 接收 docs/ 文档库全文内容与演进意图，从知识图谱视角分析跨文档方向对齐/概念一致性/覆盖缺口，输出包含结构操作与内容操作的整体变更计划，供 /evolve 命令执行
---

# doc-tree-evolve

> **Skill ID**：`doc-tree-evolve`
> **版本**：2.0.0
> **用途**：接收文档库全文内容和用户演进意图，进行全库知识分析，输出结构化变更计划（结构操作 + 内容操作），供 `/evolve` 命令执行

---

## 触发条件

本 Skill 由 `/evolve` 命令内部调用，不直接面向用户触发。

---

## 输入

| 参数 | 必需 | 说明 |
|------|:----:|------|
| `tree_snapshot` | 是 | 文件元数据快照：每个文件的路径、行数、H1 标题、所有 H2 标题列表、引用关系（references/referenced_by） |
| `doc_contents` | 是 | 全文内容映射：`{ path → full_content }`（对超长文档可为 H2 首段摘要） |
| `current_index` | 是 | 当前 `docs/index.md` 全文，含"当前探索方向"声明 |
| `intent` | 是 | 用户的演进意图（自然语言描述） |
| `max_lines` | 否 | 单文档篇幅上限，默认 `300` |

**`tree_snapshot` 格式示例**：

```yaml
files:
  - path: "docs/vision/overview.md"
    lines: 180
    title: "终生数字系统愿景"
    h2_sections: ["背景", "核心哲学", "三大支柱", "与超级 App 的区别"]
    referenced_by: ["docs/index.md", "docs/system-design/core-principles.md"]
    references: ["docs/vision/concepts.md"]
  - path: "docs/infrastructure/service-hub.md"
    lines: 240
    title: "服务中心系统"
    h2_sections: ["服务注册", "跨平台 IPC", "MCP 协议对齐"]
    referenced_by: ["docs/index.md"]
    references: []
diagnostics:
  overlong_files: []
  orphan_files: ["docs/old-notes.md"]
  broken_refs: ["docs/system-design/roadmap.md -> docs/deleted-milestone.md"]
  uncollected_files: []
```

---

## 执行步骤

### 步骤 1：理解意图

解析 `intent`，分类为以下一种或多种：

| 意图类型 | 说明 | 示例 |
|---------|------|------|
| `DIRECTION_CHANGE` | 探索方向转变，需全库内容对齐新方向 | "我现在转向研究分布式一致性协议" |
| `RESTRUCTURE` | 重新组织目录结构 | "文档太多了，帮我重新分类整理" |
| `SPLIT` | 拆分超长文档 | "把这篇文档拆成几个小文件" |
| `MERGE` | 合并碎片文档 | "这几篇笔记合并成一篇" |
| `ARCHIVE` | 归档不再活跃的文档 | "之前的组件平台设计暂时搁置" |
| `GAP_FILL` | 填补知识缺口，新建文档 | "扩充文档库，填上缺失的覆盖面" |
| `CONCEPT_SYNC` | 同步跨文档的概念定义 | "统一全库中'能力总线'的定义" |
| `CLEANUP` | 清理断裂引用和孤立文档 | "帮我清理一下引用关系" |

---

### 步骤 2：全库内容分析（核心步骤）

基于 `doc_contents` 和 `current_index` 进行深度分析：

**2.1 提取基准方向**

从 `current_index` 中提取"当前探索方向"声明（包括方向描述、核心哲学、当前锚点），作为全库对齐基准。

**2.2 方向对齐度分析**

对每篇文档（基于全文内容），评估与基准方向的对齐程度：

- **高度对齐**：文档主题与当前方向直接相关，内容无需重大更新
- **部分对齐**：主题相关，但部分内容指向旧方向或过时技术方案，需局部更新
- **方向偏离**：文档主题与当前方向无关或已完全过时，候选归档
- **内容陈旧**：文档内容引用了已归档文档中的设计、已废弃的架构决策

对"部分对齐"和"内容陈旧"文档，**具体标注哪些章节（H2）需要更新，以及需要更新的方向**。

**2.3 概念一致性分析**

在全文内容中提取核心概念的使用情况：

1. 识别各文档中的概念定义（形如"X 是...""X 指...""X：..."的句子）
2. 对同一概念，比较各文档中的定义差异
3. 对存在不一致的概念，标注：
   - 概念名称
   - 各文档的定义原文
   - 推荐的权威定义（通常来自概念定义文档或最详细的说明）
   - 需要更新的目标文档列表

**2.4 覆盖缺口分析**

基于当前探索方向和现有文档，识别知识缺口：

- **主题缺口**：方向声明的核心锚点中，哪些主题尚无对应文档
- **深度缺口**：已有文档仅为概述，缺乏深入的专题文档（如"AI 集成"只有概述，缺少具体的权限模型文档）
- **连接缺口**：文档间应有引用关系但实际缺失

**2.5 结构诊断**

基于 `tree_snapshot.diagnostics`：

- 超长文档（行数 > `max_lines`）
- 孤立文档（`referenced_by` 为空）
- 断裂引用
- 未收录文档
- 目录嵌套超过 3 层的路径

---

### 步骤 3：生成变更计划

根据意图类型 + 全库分析结果，输出一组有序操作。

**结构操作**：

| 操作类型 | 参数 | 说明 |
|---------|------|------|
| `CREATE_DIR` | `path` | 创建新目录 |
| `MOVE_FILE` | `from`, `to`, `reason` | 移动文件到新位置 |
| `SPLIT_FILE` | `source`, `targets[]`, `strategy` | 将超长文档拆分为多个子文档 |
| `MERGE_FILES` | `sources[]`, `target`, `strategy` | 将多个文档合并为一个 |
| `ARCHIVE` | `path`, `archive_path` | 将文档移入归档目录 |
| `UPDATE_REFS` | `file`, `old_ref`, `new_ref` | 更新某文件中的引用路径 |

**内容操作**（新增）：

| 操作类型 | 参数 | 说明 |
|---------|------|------|
| `UPDATE_SECTION` | `file`, `section_title`, `new_content`, `reason` | 更新文档中特定章节的内容（`new_content` 必须是完整的新章节内容，不得留白） |
| `CREATE_FILE` | `path`, `title`, `outline`, `initial_content`, `reason` | 创建新文档填补知识缺口（`initial_content` 须包含完整的初始内容框架） |
| `SYNC_CONCEPT` | `concept`, `authoritative_source`, `new_definition`, `targets[]` | 跨文档同步概念定义；`targets` 列出需要更新的文件路径 |

**索引操作**：

| 操作类型 | 参数 | 说明 |
|---------|------|------|
| `UPDATE_INDEX` | `new_content` | 重新生成 index.md 完整内容（始终最后执行） |

**操作排序原则**：

1. `CREATE_DIR` 最先（确保目标目录存在）
2. `MOVE_FILE` / `SPLIT_FILE` / `MERGE_FILES` / `ARCHIVE` 次之（文件位置确定）
3. `UPDATE_REFS` 再次（引用路径已确定）
4. `UPDATE_SECTION` / `CREATE_FILE` / `SYNC_CONCEPT` 再次（内容在结构稳定后更新）
5. `UPDATE_INDEX` 最后（文档地图反映最终状态）

---

### 步骤 4：生成影响说明

为每个操作附带：

- **涉及文件**：受影响的文件列表
- **变更原因**：关联到具体的分析发现（方向偏离/概念不一致/知识缺口/结构问题）
- **风险等级**：
  - `低`：新建文件/目录、更新 index.md
  - `中`：移动文件、更新章节内容、概念同步
  - `高`：拆分/合并文档、大规模重组、批量概念替换

---

## 输出格式

```markdown
# 文档库演进方案

> **意图**：{用户意图摘要}
> **生成时间**：{当前日期}
> **影响范围**：{受影响文件数} 个文件，{总操作数} 项操作（结构操作 {N} 项，内容操作 {N} 项）

---

## 全库知识诊断

### 方向对齐度

| 文档 | 对齐度 | 问题摘要 |
|------|:------:|---------|
| {path} | 高 | — |
| {path} | 中 | {具体章节} 内容与当前方向不符，需更新 |
| {path} | 低 | 整篇文档指向旧方向，建议归档 |

### 概念不一致

| 概念 | 文档 A | 文档 A 的定义 | 文档 B | 文档 B 的定义 | 推荐权威来源 |
|------|--------|-------------|--------|-------------|------------|
| {概念名} | {path} | {定义原文} | {path} | {定义原文} | {source path} |

### 覆盖缺口

| 缺口类型 | 主题 | 说明 |
|---------|------|------|
| 主题缺口 | {主题名} | 当前方向锚点"{锚点}"无对应文档 |
| 深度缺口 | {主题名} | {path} 仅为概述，缺乏专题深入 |

### 结构诊断

- 超长文档：{列表或"无"}
- 孤立文档：{列表或"无"}
- 断裂引用：{列表或"无"}
- 未收录文档：{列表或"无"}

---

## 变更计划

### 操作 1：{操作类型}

- **目标**：{操作参数（文件路径、章节名等）}
- **原因**：{具体的变更原因，关联到上方诊断}
- **风险**：{低/中/高}
- **影响文件**：{文件列表}
- **新内容**（仅 UPDATE_SECTION / CREATE_FILE）：
  ```
  {完整的新内容或初始内容框架}
  ```

### 操作 2：{操作类型}

{重复上述结构}

---

## 操作执行顺序

1. {操作摘要 1}
2. {操作摘要 2}
...
N. UPDATE_INDEX — 重新生成 docs/index.md

---

## 新 index.md 草稿

{完整的新 index.md 内容}
```

---

## 缺失信息处理

| 场景 | 处理方式 |
|------|---------|
| `tree_snapshot` 未提供 | 无法执行，返回错误提示 |
| `doc_contents` 未提供 | 降级为纯结构分析，跳过步骤 2.1-2.4，在方案中注明"已降级为结构分析模式" |
| `intent` 过于模糊（如"整理一下"） | 基于诊断结果提出 2-3 个具体演进方向，在变更计划前列出建议 |
| 文档数量过多（>20 篇），内容分析量过大 | 优先分析"方向偏离"文档和 index.md 标注的核心文档，其余用 H2 首段摘要代替全文 |
| 文档间存在循环引用 | 在诊断结果中标记，变更计划中不主动打破循环（除非用户意图包含 CLEANUP） |

---

## 注意事项

1. **只规划不执行**：本 Skill 只输出变更计划，不执行任何文件操作；执行由 `/evolve` 命令负责
2. **内容操作须完整**：`UPDATE_SECTION` 的 `new_content` 和 `CREATE_FILE` 的 `initial_content` 必须包含具体内容，不得输出"待填充"占位符；这是 Skill 的核心价值所在
3. **SYNC_CONCEPT 须指定权威来源**：同步前必须在 `authoritative_source` 中指明哪个文档的定义作为标准，并给出 `new_definition` 的具体文本
4. **引用完整性**：每次 `MOVE_FILE` 或 `SPLIT_FILE` 操作，必须配套 `UPDATE_REFS` 操作更新所有受影响的引用
5. **index.md 始终最后更新**：任何文件结构或内容变更后，最终操作必须包含 `UPDATE_INDEX`
6. **归档不删除**：`ARCHIVE` 操作将文件移入 `docs/_archive/` 目录，不删除文件
7. **大刀阔斧**：当诊断发现多处系统性问题时，优先提出整体性方案（如一次性重新分类所有文档），而非零散修补。单次演进应有明确的核心主题，不做小修小补的集合
