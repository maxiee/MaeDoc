---
name: doc-iterate
description: 基于用户反馈对文档进行定向迭代优化，精准定位需要修改的章节，生成修改方案，输出 diff 格式变更内容与变更说明
---

# doc-iterate

> **Skill ID**：`doc-iterate`
> **版本**：1.0.0
> **类型**：instruction
> **用途**：根据用户反馈（自然语言或结构化）对文档进行定向迭代，输出修改后的文档 diff 与变更说明

---

## 触发条件

当用户说出以下类似意图时，激活本 Skill：

- "根据这个反馈修改文档"
- "补充一下安全章节"
- "把第三章改成……"
- "按照审阅建议修改这篇文档"
- "iterate 这个文档"
- "帮我优化一下这部分内容"
- 或由 `/iterate` 命令内部调用，或由 `doc-review` / `doc-quality-score` 输出的后续建议触发

---

## 输入

本 Skill 需要以下信息（如未提供，按照"缺失信息处理"步骤主动收集）：

| 参数 | 必需 | 说明 |
|------|:----:|------|
| `document` | 是 | 待迭代的文档内容或文件路径 |
| `feedback` | 是 | 用户反馈：自然语言描述（如"补充威胁模型分析"）或结构化问题列表（如 `doc-review` 输出的 P0/P1 问题） |
| `doc_type` | 否 | 文档类型（`type_id`），如 `tech-design`、`blog-post`；未指定则按通用规范处理 |
| `scope` | 否 | 迭代范围限定：`all`（全文）/ `section:{章节名}`（指定章节）/ `diff_only`（仅输出变更部分）；默认 `all` |
| `style` | 否 | 迭代风格：`minimal`（最小变更，不改动未涉及内容）/ `enhanced`（在修改基础上适当补充）；默认 `minimal` |

---

## 执行步骤

> **交互原则**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，不得直接输出文本等待用户回复。

### 步骤 1：解析与准备

1. 读取文档，提取：
   - 所有章节（H1/H2/H3 标题）及其内容
   - 文档元信息（标题、作者、日期、版本等）
   - 现有的 `[假设]`、`[待确认]`、`[TBD]` 标注
2. 解析 `feedback`，识别反馈类型：
   - **自然语言反馈**：提取动作意图（新增/修改/删除/补充/优化）+ 目标章节 + 具体要求
   - **结构化问题列表**（来自 `doc-review` / `doc-quality-score`）：按 P0→P1→P2 优先级排序处理
3. 若提供 `doc_type`：
   - 读取 `docs/_templates/{type_id}/type.json`（获取章节结构要求）
   - 读取 `docs/_templates/{type_id}/guidelines.md`（获取类型专属写作规范）
4. 读取通用写作规范：`docs/_templates/writing-guidelines.md`

---

### 步骤 2：意图映射与影响分析

1. 将每条反馈映射为具体操作：

   | 操作类型 | 说明 | 示例 |
   |---------|------|------|
   | `ADD_SECTION` | 新增章节（文档中尚不存在） | "补充安全章节" |
   | `MODIFY_SECTION` | 修改现有章节内容 | "把背景章节改得更简洁" |
   | `DELETE_SECTION` | 删除章节 | "去掉附录部分" |
   | `EXPAND_CONTENT` | 扩展指定章节的内容深度 | "详细说明部署步骤" |
   | `RESTRUCTURE` | 调整章节顺序或层级 | "把风险章节移到测试前面" |
   | `FIX_CONSISTENCY` | 修复不一致问题 | "统一术语：全文用'消息队列'替换'MQ'" |
   | `FIX_FORMAT` | 修复格式问题 | "给代码块添加语言标注" |

2. 分析每个操作的影响范围：
   - 列出将被修改的章节列表
   - 标注"只读章节"（未涉及的章节，`style=minimal` 时不触碰）
   - 若操作涉及跨章节一致性（如术语替换），标注全文影响

3. 生成操作计划（供内部使用）：
   ```
   操作 1：ADD_SECTION "安全与隐私考量" —— 位置：在"测试策略"之前
   操作 2：FIX_CONSISTENCY "消息队列" 替换 "MQ"（全文 3 处）
   操作 3：EXPAND_CONTENT "部署与运维" —— 补充回滚策略说明
   ```

4. **在执行前**，若反馈涉及以下高风险操作，使用 `question` 工具先确认用户意图：
   - 删除现有章节（尤其是必需章节）
   - 大规模重组（影响超过 50% 章节）
   - 修改与文档其他章节高度耦合的核心定义

   `question` 工具格式示例：
   - **标题**：确认高风险操作
   - **问题**：以下操作影响较大，请确认是否继续：{操作描述}
   - **选项**：确认继续 / 取消此操作 / 调整为最小变更

---

### 步骤 3：执行迭代修改

按操作计划逐条执行，遵循以下原则：

**通用写作规范**（参见 `docs/_templates/writing-guidelines.md`）：
- 新增内容与原文风格保持一致（语言、语气、术语使用）
- 保持章节头部的元信息格式（如"**负责人**：XXX"等已有格式）
- 新增内容中的不确定信息，显式标注为 `[假设]` 或 `[待确认]`
- 不得在修改过程中意外删除 `[假设]` / `[TBD]` / `[待确认]` 标注

**`ADD_SECTION` 操作规范**：
1. 参考 `doc_type` 的章节模板（如有）或通用文档最佳实践
2. 确定章节位置（通常跟随类型定义的顺序，或用户指定位置）
3. 生成章节内容，内容深度与文档整体相匹配
4. 若内容中存在无法确定的信息，标注 `[待确认]`

**`MODIFY_SECTION` 操作规范**：
1. 只修改用户反馈指向的具体内容，不改动其他段落
2. 若反馈模糊（如"改得更好"），先呈现计划让用户确认
3. 对数据、指标的修改需在变更说明中注明修改依据

**`FIX_CONSISTENCY` 操作规范**：
1. 全文替换时，列出所有替换位置
2. 替换前核查目标术语是否有多种合法变体（如品牌名大小写）
3. 不替换代码块内的内容（代码块中的术语视为精确字面量）

---

### 步骤 4：生成 diff 与变更说明

1. 对比修改前后的文档，生成 **语义化 diff**（非逐行 patch，而是人类可读的变更描述）：
   - 新增的内容块：用 `+ ` 前缀标注
   - 删除的内容块：用 `- ` 前缀标注
   - 修改的内容块：并排展示原文 vs 新文
2. 为每个变更生成说明，包含：
   - 变更类型（新增/修改/删除/修复）
   - 涉及章节
   - 变更原因（关联到用户的哪条反馈）
   - 信心等级（高/中/低）及说明

---

## 输出格式

```markdown
# 文档迭代报告

> **文档**：{文档标题或文件路径}
> **迭代时间**：{当前日期}
> **反馈来源**：{自然语言 / doc-review P0-P1 / doc-quality-score 改进建议}
> **迭代范围**：{受影响的章节列表}

---

## 变更摘要

共执行 {N} 项变更：
- ✅ 新增：{n1} 处
- ✏️ 修改：{n2} 处
- 🗑️ 删除：{n3} 处
- 🔧 修复：{n4} 处

---

## 变更详情

### 变更 1：{操作类型} — 「{章节名}」

**反馈依据**：{关联的用户反馈或 P0/P1 问题编号}
**信心等级**：高 / 中 / 低
**信心说明**：{若为中/低，解释原因，如"用户反馈模糊，此处做了合理推断"}

**变更内容**：

```diff
- {原文内容（若为新增则无此行）}
+ {新内容（若为删除则无此行）}
```

**变更说明**：{1-2 句话说明为何做此修改，以及修改的核心思路}

{若新增内容中有待确认项：}
> ⚠️ 本变更包含以下待确认项：
> - `[待确认]` {具体内容}，建议与 {相关方} 确认后填充

---

### 变更 2：{操作类型} — 「{章节名}」

{重复上述结构}

---

## 完整修改后文档

{输出修改后的完整文档内容}

---

## 未处理的反馈项

{如有反馈未被处理，列出原因：}

| 反馈项 | 未处理原因 | 建议 |
|--------|-----------|------|
| {反馈描述} | {原因，如：需要用户提供更多信息 / 超出当前文档范围 / 存在歧义} | {如何解决} |

{如所有反馈均已处理，此章节写"所有反馈项已处理完毕。"}

---

## 后续建议

{根据迭代结果给出 1-3 条建议，如：}
1. {如：建议重新运行 `doc-quality-score` 评估迭代后的质量提升}
2. {如：新增的「安全章节」中有 2 个 `[待确认]` 项，建议尽快确认}
3. {如：若后续仍有修改需求，可继续使用 `doc-iterate` Skill}
```

---

## 缺失信息处理

| 场景 | 处理方式 |
|------|---------|
| 文档未提供 | 使用 `question` 工具请求用户提供文档内容或文件路径，不可继续 |
| 反馈未提供 | 使用 `question` 工具请求用户描述具体的修改需求，不可继续 |
| 反馈过于模糊（如"改好一点"） | 使用 `question` 工具列出 3-5 个可能的解读供用户选择或澄清，再执行 |
| `doc_type` 未指定 | 尝试从文档内容推断；无法推断则按通用规范迭代，在报告中注明 |
| 要删除的章节是必需章节 | 使用 `question` 工具警告用户该章节为文档类型的必需章节，确认是否仍要删除 |
| 反馈涉及需要外部信息的内容（如竞品数据） | 在对应位置标注 `[待确认：{需要的信息}]`，在"未处理反馈项"中注明 |
| 文档冲突（修改 A 与修改 B 互相矛盾） | 使用 `question` 工具列出冲突，请用户裁决，不自行决策 |

---

## 注意事项

1. **最小变更原则**：`style=minimal` 时（默认），只修改反馈直接指向的内容，不触碰其他章节，即使发现其他可以改进的地方
2. **保留原文风格**：迭代不得改变文档整体的语气和写作风格，除非用户明确要求
3. **不隐藏不确定性**：对于新增内容中不确定的部分，必须用 `[待确认]` 标注，不允许"凑内容"
4. **代码块保护**：代码块内的内容（反引号、围栏代码块）只在用户明确要求修改代码时才触碰
5. **变更可追溯**：每条变更必须关联到具体的反馈来源，不允许"顺手"修改未被反馈提及的内容
6. **完整输出**：修改后必须输出完整文档（而非仅输出 diff），确保用户可以直接使用输出结果
7. **迭代幂等性**：若用户对同一文档多次迭代，每次迭代基于上次输出的最新版本，变更说明应体现版本演进

---

## 质量标准

迭代输出应满足：

- [ ] 每项变更均有对应的用户反馈关联，无未授权的额外修改
- [ ] diff 格式清晰，原文与新文对比可读
- [ ] 所有不确定的新增内容均有 `[待确认]` 标注
- [ ] 未处理的反馈项有明确说明，不静默丢弃
- [ ] 输出完整的修改后文档，而非仅输出变更片段
- [ ] 变更摘要的计数与实际变更数量一致

---

## 示例

**用户输入**：
> 请根据以下反馈修改这篇技术设计文档：
> 1. 补充"安全与隐私考量"章节，重点分析威胁模型
> 2. 把"背景"章节中 QPS 由 500 统一改为 5000（P0 数据矛盾）
> 3. 全文将"MQ"统一替换为"消息队列"

**Skill 行为**：
1. 读取文档，提取章节树；识别到文档类型为 `tech-design`
2. 加载 `docs/_templates/tech-design/type.json`，确认"安全与隐私考量"为必需章节
3. 将 3 条反馈映射为操作：
   - 操作 1：`ADD_SECTION "安全与隐私考量"`（位置：在"测试策略"之前）
   - 操作 2：`FIX_CONSISTENCY` QPS 500→5000（定位：背景章节第 2 段 + 风险章节第 1 段）
   - 操作 3：`FIX_CONSISTENCY` "MQ"→"消息队列"（全文 3 处，跳过代码块）
4. 执行迭代：
   - 新增"安全与隐私考量"章节，包含 STRIDE 威胁分析框架，未确定部分标注 `[待确认]`
   - 修改两处 QPS 数值，在变更说明中注明"以风险章节的 5000 为准"
   - 替换 3 处"MQ"，在代码块中的"MQ"保留不动
5. 生成迭代报告：变更摘要（新增 1、修改 2、修复 3）+ 完整修改后文档 + 后续建议（建议重新运行 `doc-quality-score`）
