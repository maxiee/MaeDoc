---
name: ingest-remote
description: 读取用户从外部 AI 获取的回答（.docforge/inbox/），展示建议摘要，引导用户选择采纳哪些建议，并将确认的修改应用到对应文档中。
---

# /ingest-remote 命令

> **命令**：`/ingest-remote`
> **版本**：1.0.0
> **用途**：将外部 AI 的回答引入本地工作流——解析 inbox 文件中的建议，让用户决定采纳哪些，并将确认的修改写回文档

---

## 用法

```
/ingest-remote <slug>
```

**示例**：

```
/ingest-remote 20250220-143000-cap-theorem
/ingest-remote argument-logic-review
/ingest-remote
```

- `<slug>` 可以是完整文件名（`20250220-143000-cap-theorem`）、文件名中的部分关键词，或省略（自动查找最新 inbox 文件）

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **确认优先**：在应用任何修改之前，必须向用户展示将要修改的内容并获得明确确认，不得直接写入文件。

---

## 任务意识框架

在本命令执行**全程**，同时运行两种意识模式：

**主线模式**：专注高质量地引入外部 AI 建议，将确认的修改写回文档。

**后台扫描模式**：以"文档生态守护者"的视角，持续留意以下改进信号。每次信号出现时，**即时在心智便签中标记**（不打断主流程，供末尾"TODO 录入"阶段处理）：

- 被跳过的外部 AI 建议——特别是因"范围太大"或"需要更多背景"而跳过的（这些是高价值 TODO 候选项）
- 应用建议时生成的 `[待确认]` 标注——**每处标注即对应一个潜在 TODO**
- 应用建议时发现关联文档也需要更新，但本次未处理

> **发现并记录改进机会，与完成核心任务同等重要。** 末尾"TODO 录入"阶段会处理这些心智便签。

---

## 执行流程

### 阶段 0：定位 inbox 文件

**步骤 0.1：提取命令参数**

命令参数（用户在命令后输入的内容）：`$ARGUMENTS`

从参数中提取 `slug`（文件名或关键词）。若参数为空，`slug` 为空，进入步骤 0.2 的自动查找逻辑。

**步骤 0.2：查找 inbox 文件**

扫描 `.docforge/inbox/` 目录中的所有 `.md` 文件：

- 若 `slug` **非空**：
  - 优先查找文件名**完全匹配** `{slug}.md` 的文件
  - 若无完全匹配，查找文件名**包含** `slug` 关键词的文件
  - 若匹配到多个文件，使用 `question` 工具让用户选择：
    - **标题**：选择 inbox 文件
    - **问题**：找到以下匹配的 inbox 文件，请选择要处理的文件：
    - **选项**：列出匹配文件名（最多 4 个）
  - 若无任何匹配，转步骤 0.3

- 若 `slug` **为空**：
  - 列出 `.docforge/inbox/` 下所有 `.md` 文件，按修改时间降序排列
  - 若有文件：使用 `question` 工具让用户选择：
    - **标题**：选择要处理的 inbox 文件
    - **问题**：以下是 inbox 中的文件，请选择要处理的文件（最新在前）：
    - **选项**：列出文件名（最多 4 个）+ 追加"手动输入文件名"
  - 若目录为空，转步骤 0.3

**步骤 0.3：inbox 为空或无匹配时的处理**

使用 `question` 工具提示并询问：

- **标题**：未找到 inbox 文件
- **问题**：在 `.docforge/inbox/` 中未找到匹配的文件。请确认以下事项后，输入正确的文件名（不含扩展名）：
  1. 已将外部 AI 的回答保存为 `.docforge/inbox/{filename}.md`
  2. 文件名与 `.docforge/outbox/` 中的对应文件名完全一致
- **说明**：输入文件名（不含 `.md`），或回车取消

若用户取消，终止命令并提示：`已取消。请先将外部 AI 的回答保存到 .docforge/inbox/ 后再运行此命令。`

记录匹配文件名（不含扩展名）为 `filename`，完整 inbox 路径为 `inbox_file = .docforge/inbox/{filename}.md`。

---

### 阶段 1：读取内容并定位源文档

**步骤 1.1：读取 inbox 文件**

读取 `inbox_file` 的全部内容，记录为 `inbox_content`。

**步骤 1.2：读取对应的 outbox 文件**

尝试读取 `.docforge/outbox/{filename}.md`，记录为 `outbox_content`：

- 若 outbox 文件**存在**：从 `outbox_content` 的元信息（`> 源文档：`行）中提取原始文档路径，记录为 `target_doc`
- 若 outbox 文件**不存在**：使用 `question` 工具询问：
  - **标题**：指定目标文档
  - **问题**：未找到对应的 outbox 文件（`.docforge/outbox/{filename}.md`）。请输入这份外部 AI 回答对应的原始文档路径（如 `docs/my-design.md`）：
  - 记录用户输入为 `target_doc`

**步骤 1.3：验证目标文档存在**

检查 `target_doc` 对应的文件是否存在：

- 若**存在**：读取文档内容，记录为 `doc_content`，继续阶段 2
- 若**不存在**：使用 `question` 工具提示错误并请用户重新输入：
  - **标题**：文档不存在
  - **问题**：未找到文件 `{target_doc}`，请重新输入正确的文档路径：
  - 重复验证，直到路径有效

---

### 阶段 2：解析外部 AI 建议

**步骤 2.1：分析 inbox 内容**

基于 `inbox_content`，分析外部 AI 的回答，提取所有可操作的建议项。每条建议包含：

- **建议 ID**：编号（B1、B2、B3……）
- **建议类型**：`新增内容` / `修改内容` / `删除内容` / `结构调整` / `其他意见`
- **影响章节**：建议所涉及的文档章节（若不涉及具体章节，标注"全文"）
- **建议摘要**：一句话概括（不超过 50 字）
- **建议详情**：外部 AI 对该建议的原文或完整阐述

若外部 AI 的回答不含可直接操作的建议（如纯分析性讨论），标记 `suggestion_type = analysis_only`，进入步骤 2.2 的特殊处理分支。

**步骤 2.2：展示建议摘要**

输出如下格式的建议列表（纯文本展示，无需 question 工具）：

```
---

📬 **外部 AI 回答摘要**

来源文件：.docforge/inbox/{filename}.md
目标文档：{target_doc}
建议总数：{N} 条

| ID | 类型 | 影响章节 | 建议摘要 |
|----|------|---------|---------|
| B1 | {类型} | {章节} | {摘要} |
| B2 | {类型} | {章节} | {摘要} |
| …  |  …   |   …     |    …    |

---
```

若 `suggestion_type = analysis_only`，展示：

```
---

📬 **外部 AI 回答摘要**

来源文件：.docforge/inbox/{filename}.md
目标文档：{target_doc}

⚠️ 外部 AI 的回答以分析和讨论为主，未包含可直接操作的修改建议。

回答要点摘要：
{用 3-5 个要点概括外部 AI 的主要观点}

---
```

并跳转到阶段 3 的特殊处理（步骤 3.2）。

---

### 阶段 3：用户确认采纳哪些建议

**步骤 3.1：逐条或批量确认（常规建议）**

使用 `question` 工具询问用户的采纳策略：

- **标题**：选择采纳策略
- **问题**：以上共 {N} 条建议，请选择处理方式：
- **选项**：
  1. 全部采纳，直接应用到文档（Recommended）
  2. 逐条审查，选择性采纳
  3. 放弃，不做任何修改

根据用户选择：

- **选择 1（全部采纳）**：`adopted_suggestions` = 全部建议，直接进入阶段 4
- **选择 2（逐条审查）**：对每条建议，依次使用 `question` 工具询问（每次询问一条）：
  - **标题**：建议 {ID}：{建议摘要}
  - **问题**：{建议详情}

    请选择对此建议的处理方式：
  - **选项**：
    1. 采纳——应用到文档（Recommended）
    2. 跳过——保留原文不变
  - 将采纳的建议加入 `adopted_suggestions`，跳过的加入 `skipped_suggestions`
  - > 💡 **后台扫描触发点**：每次选择"跳过"时，立即判断跳过原因：若是因"建议质量不佳"而跳过，则无需记录；若是因"范围太大"、"需要更多背景"、"值得专项处理"而跳过，则在心智便签中标记（建议 ID + 跳过原因）——这类跳过是高价值 TODO 候选项。
  - 所有建议审查完毕后，进入阶段 4
- **选择 3（放弃）**：输出 `已取消，文档未做任何修改。` 并终止

**步骤 3.2：纯分析回答的处理**

使用 `question` 工具询问：

- **标题**：如何处理分析内容
- **问题**：外部 AI 的回答主要是分析性内容，请选择后续操作：
- **选项**：
  1. 将分析要点作为备注附加到文档末尾（Recommended）
  2. 基于分析内容手动描述修改需求，转为 /iterate 处理
  3. 不做任何修改，仅供参考

根据用户选择：
- **选择 1**：将分析要点整理为"外部 AI 分析备注"章节，附加到文档末尾，进入阶段 4
- **选择 2**：使用 `question` 工具提示：`请使用 /iterate {target_doc} <你的修改需求> 来应用这些分析。` 并终止
- **选择 3**：输出 `已记录分析内容，文档未做修改。` 并终止

---

### 阶段 4：生成修改方案并写入文档

**步骤 4.1：生成修改后文档**

基于 `doc_content` 和 `adopted_suggestions`，生成修改后的完整文档内容：

- 按建议中指定的章节定位修改位置
- 对 `新增内容` 类建议：在对应章节后插入新内容
- 对 `修改内容` 类建议：替换对应段落
- 对 `删除内容` 类建议：删除对应段落
- 对 `结构调整` 类建议：调整章节顺序或层级
- 对被采纳建议但有不确定之处：保留内容并添加 `[待确认]` 标注

记录修改后的完整文档为 `updated_doc_content`。

**步骤 4.2：展示变更摘要并请求最终确认**

使用 `question` 工具展示变更内容并请求确认：

- **标题**：确认并应用修改
- **问题**：已基于 {M} 条采纳建议（跳过 {K} 条）生成修改方案，变更摘要如下：

  {逐条列出已采纳的建议 ID + 摘要}

  请确认是否将上述修改写入 `{target_doc}`：
- **选项**：
  1. 确认写入（Recommended）
  2. 放弃，保留原文件不变

根据用户选择：
- **选择 1（确认写入）**：继续步骤 4.3
- **选择 2（放弃）**：输出 `已取消，文档未做任何修改。` 并终止

**步骤 4.3：写入文档**

将 `updated_doc_content` 写入 `target_doc`（覆盖原文件）。

写入完成后，输出完成摘要：

```
---

文档更新完成！

📄 **目标文档**：{target_doc}
✅ **已采纳**：{M} 条建议
⏭️ **已跳过**：{K} 条建议
📌 **待确认项**：{P} 个 [待确认] 标注需后续跟进（若无则显示"无"）

**建议后续操作**：
- 使用 `/review {target_doc}` 验证更新后的整体质量
- 如有进一步修改需求，使用 `/iterate {target_doc} <反馈>` 继续优化
```

---

### 阶段 5：TODO 录入（必做）

> 将心智便签中的改进信号写入 `docs/TODO.md`。

**触发线索**（逐条判断）：

1. 跳过的建议中有因"范围太大"或"需要专项处理"而跳过的？
2. 应用建议后新增了 `[待确认]` 标注？
3. 关联文档需要更新但未处理？
4. 用户在审查中提及了未处理的想法？
5. 外部 AI 建议涉及跨多文档协调？

**对"是"项**：读取 `.opencode/skills/todo-append/SKILL.md`，按步骤追加到 `docs/TODO.md`。

**完成声明**：有记录写 `已记录 T-NNN`；零 TODO 逐条说明为何未触发。

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| `.docforge/inbox/` 目录不存在 | 提示"inbox 目录不存在，请先通过 /escalate 生成 outbox 文件并将外部 AI 回答保存到 inbox 目录"，终止命令 |
| inbox 文件为空 | 提示"inbox 文件内容为空，请确认已将外部 AI 的完整回答粘贴到文件中"，终止命令 |
| 无法解析到任何建议 | 转入纯分析回答处理流程（步骤 3.2） |
| 目标文档写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |
| 修改位置无法定位（章节不存在） | 对该条建议标注"无法定位章节"，询问用户是否跳过该条或手动指定插入位置 |

---

## 流程图

```
/ingest-remote <slug>
    │
    ▼
[阶段 0] 定位 inbox 文件
    │ slug 非空 → 匹配文件名 → 多个匹配 → question 工具选择
    │ slug 为空 → 列出所有 inbox 文件 → question 工具选择
    │ 无文件 → question 工具询问文件名，或取消
    ▼
[阶段 1] 读取 inbox + 关联 outbox → 确定 target_doc
    │ outbox 存在 → 从 outbox 元信息提取文档路径
    │ outbox 不存在 → question 工具询问文档路径
    │ 验证 target_doc 存在（循环直到有效）
    ▼
[阶段 2] 解析建议 → 展示建议摘要（N 条）
    │ 含可操作建议 → 继续阶段 3
    │ 纯分析内容 → 步骤 3.2 特殊处理
    ▼
[阶段 3] 用户确认采纳策略 → question 工具
    │ 全部采纳 → adopted_suggestions = 全部
    │ 逐条审查 → 逐条 question 确认 → adopted_suggestions = 选中项
    │ 放弃 → 终止
    ▼
[阶段 4] 生成修改后文档 → 展示变更摘要 → question 工具最终确认
    │ 确认写入 → 写入 target_doc → 输出完成摘要
    └─ 放弃 → 输出"已取消"，终止
    ▼
[阶段 5] TODO 录入（必做）→ 判断 5 项触发线索 → 追加 TODO 或说明为何无项
```

---

## 注意事项

1. **文件名一致性**：inbox 文件名必须与 outbox 文件名完全一致，命令依赖此对应关系定位源文档路径；若 outbox 文件丢失，命令会手动询问目标文档路径
2. **建议来源透明**：每条采纳建议的来源（外部 AI 的原文）都会在逐条审查时展示，用户对采纳内容始终知情
3. **确认后写入**：步骤 4.2 的最终确认是最后一道关卡，在此之前任何操作都不会改动原文件
4. **待确认项标注**：对不确定的修改使用 `[待确认]` 标注而非强制应用，保持文档可追溯性
5. **可反复调用**：若同一 inbox 文件对应的建议需要多次处理（如先采纳部分，再补充采纳），可再次运行 `/ingest-remote` 处理同一文件
