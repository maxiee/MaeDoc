---
name: evolve
description: 以整个文档库为单位进行演进——通过 doc-library-analyst SubAgent 在独立上下文中扫描全库，构建跨文档知识图谱，分析方向对齐度/概念一致性/覆盖缺口，主 Agent 基于分析报告生成变更计划，确认后执行并更新 index.md。
---

# /evolve 命令

> **命令**：`/evolve`
> **版本**：3.0.0
> **用途**：以**整个文档库**为单位进行演进——通过 `doc-library-analyst` SubAgent 在独立上下文中完成全库分析，主 Agent 专注于变更决策和执行

---

## 用法

```
/evolve <演进意图>
```

**示例**：

```
/evolve 我现在转向研究分布式一致性协议，之前的组件平台设计暂时搁置
/evolve 全面梳理一遍文档库，消除不一致，让所有文档对齐当前方向
/evolve 把 infrastructure/ 下的文档重新按"数据/能力/视图"三大支柱分类
/evolve 扩充文档库，把现在方向的覆盖缺口都填上
/evolve 清理断裂引用和孤立文档
```

---

## 核心理念

> `/evolve` 将文档库视为**活的知识图谱**，而非静态文件集合。每次演进：
>
> - **读懂每篇文档的真实内容**，而非只看文件名和标题
> - **理解文档间的概念依赖与方向对齐**，找到全库的薄弱环节
> - **以"知识连贯性"为标准驱动变更**，而非仅靠文件大小/位置判断
> - **全库联动**：一个方向变化可能需要更新十篇文档的内容

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **确认优先**：所有文件操作前必须展示完整变更计划并获得用户确认，不得自动执行。

---

## 任务意识框架

在本命令执行**全程**，同时运行两种意识模式：

**主线模式**：专注高质量地完成文档库演进，执行变更计划。

**后台扫描模式**：以"文档生态守护者"的视角，持续留意以下改进信号。每次信号出现时，**即时在心智便签中标记**（不打断主流程，供末尾"TODO 录入"阶段处理）：

- 全库扫描（阶段 1）识别出的、未被纳入本次变更计划的改进点
- 用户在阶段 3 选择"部分执行"时跳过的操作（这些已有专项检查 A，但仍需意识到）
- 执行过程中发现的、需要专项内容质量处理的文档问题
- 用户在对话中提及的后续演进方向，本次未覆盖

> **发现并记录改进机会，与完成核心任务同等重要。** 末尾"TODO 录入"阶段会处理这些心智便签。

---

## 执行流程

### 阶段 0：获取演进意图

1. 从 `/evolve` 命令参数提取用户的演进意图
2. 若用户未提供意图（直接输入 `/evolve` 无参数），使用 `question` 工具提问：
   - **问题**：你希望如何演进文档库？
   - **选项**：
     1. 传播方向变化（当前探索方向已转变，全库对齐新方向）
     2. 重新组织结构（重新分类、拆分超长、合并碎片）
     3. 填补知识缺口（根据当前方向，补充缺失文档）
     4. 同步概念定义（修正跨文档的术语不一致）
     5. 清理技术债务（孤立文档、断裂引用、过时内容）

   收到回答后，使用 `question` 工具追问具体细节（如新方向是什么、哪些概念需要统一等）。

---

### 阶段 1：全库深度扫描（doc-library-analyst）

> **设计原理**：全库分析需要将所有文档内容加载到上下文中，这会大量消耗主 Agent 的上下文窗口。将此任务委托给 `doc-library-analyst` SubAgent，它在独立上下文中完成全量分析，主 Agent 只接收紧凑的结构化报告。

**步骤 1.1：调用 `doc-library-analyst` SubAgent**

使用 `task` 工具调用 `doc-library-analyst` SubAgent：

- **description**：全库文档分析
- **subagent_type**：`doc-library-analyst`
- **prompt**：
  ```
  请对 docs/ 目录进行全面深度分析。

  intent（用户演进意图）:
  {阶段 0 获取的演进意图描述}

  docs_root: docs/

  请按照你的执行流程（扫描元数据 → 读取全文 → 知识特征分析 → 结构诊断）完成分析，
  并输出标准格式报告（LIBRARY_STATS、ALIGNMENT_ANALYSIS、CONSISTENCY_ISSUES、
  COVERAGE_GAPS、STRUCTURAL_DEBT、EVOLUTION_PLAN、SUMMARY）。
  ```

等待 `doc-library-analyst` 返回结构化分析报告。

**步骤 1.2：解析分析报告并输出扫描摘要**

从 `doc-library-analyst` 报告中提取关键信息，向用户展示：

```
---
docs/ 深度扫描完成（由 doc-library-analyst 执行）

{LIBRARY_STATS 内容}

📐 方向对齐度：
  高度对齐：{ALIGNMENT_ANALYSIS.高度对齐}
  方向偏离/陈旧：{ALIGNMENT_ANALYSIS.方向偏离}

🔤 概念不一致：{CONSISTENCY_ISSUES 条目数}处
📋 结构债务：{STRUCTURAL_DEBT 条目数}项
📌 覆盖缺口：{COVERAGE_GAPS 条目数}项
---
```

保存完整报告供阶段 2 使用（变量 `library_analysis`）。

---

### 阶段 2：生成演进方案

**步骤 2.1：调用 `doc-tree-evolve` Skill**

加载 `doc-tree-evolve` Skill（读取 `.opencode/skills/doc-tree-evolve/SKILL.md`），传入以下参数：

- `library_analysis`：阶段 1 保存的 `doc-library-analyst` 完整报告（含 EVOLUTION_PLAN、CONSISTENCY_ISSUES、STRUCTURAL_DEBT 等）
- `intent`：阶段 0 获取的用户意图
- `max_lines`：`300`

> **注意**：`library_analysis` 已包含所有必要的库级分析，Skill 无需重复读取全部文档。若 Skill 需要验证某个具体文档的内容，可按需读取单个文件。

Skill 输出结构化变更计划，包含操作列表（结构操作 + 内容操作）和新 index.md 草稿。

---

### 阶段 3：展示变更计划并确认

使用 `question` 工具向用户展示完整变更计划并请求确认：

**展示内容**：

1. **全库知识诊断**：方向偏离文档、概念不一致项、覆盖缺口、结构问题
2. **操作列表**：每个操作的类型、目标、原因、风险等级
3. **执行顺序**：操作的先后顺序

**确认交互**：

- **标题**：确认文档库整体演进计划
- **问题**：以上变更计划共 {N} 项操作（结构操作 {N} 项，内容操作 {N} 项）。请选择：
- **选项**：
  1. 确认执行全部操作（Recommended）
  2. 只执行结构操作（跳过内容修改，仅做文件移动/拆分/归档）
  3. 只执行低风险操作（跳过中/高风险操作）
  4. 放弃，不做任何修改

根据用户回应：

- **选择 1（全部执行）**：继续阶段 4，执行所有操作
- **选择 2（仅结构）**：过滤 `UPDATE_SECTION`、`CREATE_FILE`、`SYNC_CONCEPT` 操作，**将被过滤的内容操作列表记录到 `deferred_ops`**，继续阶段 4
- **选择 3（低风险）**：过滤中/高风险操作，**将被过滤的操作列表记录到 `deferred_ops`**，继续阶段 4
- **选择 4（放弃）**：输出 `已取消，文档库未做任何修改。` 并终止

---

### 阶段 4：执行变更

按 `doc-tree-evolve` 输出的操作顺序逐条执行：

---

**结构操作**：

**`CREATE_DIR`**：创建目录

```
mkdir -p {path}
```

**`MOVE_FILE`**：移动文件

1. 将文件从 `from` 移动到 `to`
2. 输出：`移动：{from} → {to}`

**`SPLIT_FILE`**：拆分文档

1. 读取源文件内容
2. 按拆分策略（通常按 H2 章节边界）拆分为多个子文件
3. 将子文件写入目标路径
4. 在原文件位置创建导航文件（保留标题 + 链接指向各子文件）
5. 输出：`拆分：{source} → {targets 列表}`

**`MERGE_FILES`**：合并文档

1. 按顺序读取所有源文件
2. 合并内容到目标文件（保持章节结构）
3. 删除源文件（确认后）
4. 输出：`合并：{sources 列表} → {target}`

**`ARCHIVE`**：归档文档

1. 创建 `docs/_archive/` 目录（若不存在）
2. 将文件移入归档目录
3. 输出：`归档：{path} → {archive_path}`

**`UPDATE_REFS`**：更新引用路径

1. 读取目标文件
2. 将旧引用路径替换为新路径
3. 写回文件
4. 输出：`更新引用：{file} 中 {old_ref} → {new_ref}`

---

**内容操作**（新增）：

**`UPDATE_SECTION`**：更新文档中特定章节的内容

1. 读取目标文件
2. 定位目标章节（按 H2 标题匹配）
3. 将旧章节内容替换为 Skill 提供的新内容
4. 写回文件
5. 输出：`内容更新：{file} 的「{section_title}」章节`

> 若找不到目标章节，在完成摘要中标注，不报错终止。

**`CREATE_FILE`**：创建新文档（填补知识缺口）

1. 按 Skill 提供的路径、大纲和初始内容创建新文件
2. 输出：`新建：{path}（{reason}）`

**`SYNC_CONCEPT`**：跨文档同步概念定义

1. 确定权威定义来源（Skill 指定）
2. 在各目标文档中定位该概念的旧定义/使用处
3. 更新为统一的表述
4. 输出：`同步概念「{concept}」：更新 {N} 处（{文件列表}）`

---

**索引操作**（最后执行）：

**`UPDATE_INDEX`**：更新 index.md

1. 将 Skill 输出的新 index.md 内容写入 `docs/index.md`
2. 输出：`已更新 docs/index.md`

---

每个操作执行后输出进度：

```
[{当前操作序号}/{总操作数}] {操作类型}：{操作摘要}
```

---

### 阶段 5：输出完成摘要

```
---

文档库演进完成！

📊 **执行摘要**：
- 创建目录：{N} 个
- 移动文件：{N} 个
- 拆分文件：{N} 个
- 合并文件：{N} 组
- 归档文件：{N} 个
- 更新引用：{N} 处
- 更新章节内容：{N} 处
- 新建文档：{N} 篇
- 同步概念定义：{N} 项
- 更新 index.md：✓

📌 **建议后续操作**：
- 查看 `docs/index.md` 确认文档地图准确性
- 使用 `/review` 检查受影响文档的内容质量
- 若需继续调整，再次使用 `/evolve`
```

---

### 阶段 5.5：TODO 录入（必做）

> 将执行全程心智便签中的改进信号写入全局 TODO 列表，供后续专项处理。**忠实记录真实发现的改进机会，是本次任务执行质量的体现。**

命令主体完成后，执行以下两类检查：

**专项检查 A：用户选择了部分执行（`deferred_ops` 非空）**

将 `deferred_ops` 中被跳过的操作记录为 TODO，对每项执行：
1. 读取 `.opencode/skills/todo-append/SKILL.md`
2. 按照 Skill 步骤追加到 `docs/TODO.md`：
   - 跳过了内容操作（`UPDATE_SECTION` / `CREATE_FILE` / `SYNC_CONCEPT`）：以操作目标文件为维度合并，`priority = 中`
   - 跳过了中/高风险操作（拆分/合并/移动等）：以操作类型为维度合并，`priority = 高`
   - `description`：列出所有被跳过的操作（操作类型 + 目标文件 + 跳过原因）
   - `source`：`由 /evolve 命令在执行"{演进意图摘要}"时用户选择部分执行而跳过`
   - `background`：说明这些操作是在演进分析中识别出的必要变更，后续执行时可直接重新运行 `/evolve` 并选择全部执行

**专项检查 B：阶段 4 中操作执行失败（`UPDATE_SECTION` 找不到目标章节等）**

为每个失败操作单独记录一条 TODO：
1. 读取 `.opencode/skills/todo-append/SKILL.md`
2. 按照 Skill 步骤追加到 `docs/TODO.md`：
   - `description`：说明操作类型、目标文件、目标章节，以及失败原因
   - `source`：`由 /evolve 命令在执行阶段 4 时发生错误`
   - `priority`：`高`
   - `background`：注明该操作在完整变更计划中的位置，以及手动处理时需要注意的内容

**通用检查（不论 A/B 情况，逐条判断以下具体触发线索）**：

| # | 本次执行的具体线索（对照实际执行回答，而非抽象假设） | 结论 |
|---|---|:---:|
| 1 | 全库扫描（阶段 1）识别出了改进点，但未被纳入本次变更计划（计划中未包含的诊断发现）？ | 是 / 否 |
| 2 | 阶段 4 执行过程中，发现某文档存在需要专项内容质量处理的问题（超出结构操作范围）？ | 是 / 否 |
| 3 | 用户在对话中提及了需要后续跟进的演进方向或具体关切，本次未覆盖？ | 是 / 否 |

**对通用检查中判断为"是"的项**：读取 `.opencode/skills/todo-append/SKILL.md`，按其步骤追加到 `docs/TODO.md`。

**完成摘要中必须包含以下之一（不可省略）**：

- **有 TODO 记录**：`已记录 TODO：{编号列表}`
- **零 TODO（含 A/B 和通用检查均无项）**：对上表 3 条通用线索及专项检查 A/B 的结论，每条用一句话说明为何本次执行中未触发。不可仅写"TODO 扫描：无项"而不解释。

> 提示：大规模演进任务几乎总会有被推迟的操作或发现的额外问题。若全部无项，解释将自然简短；若难以解释，说明那里确有值得记录的事项。

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| `docs/` 目录不存在 | 提示用户先使用 `/create` 创建文档 |
| `docs/index.md` 不存在 | 自动创建初始 index.md（仅含文件列表），继续流程 |
| `doc-library-analyst` SubAgent 超时或报错 | 提示用户，询问是否直接描述演进意图以简化分析；主 Agent 可按有限方式读取 docs/index.md 降级处理 |
| 移动文件时目标路径已存在同名文件 | 使用 `question` 工具询问用户：覆盖 / 重命名 / 跳过 |
| `UPDATE_SECTION` 找不到目标章节 | 跳过该操作，在完成摘要中标注，提示用户手动处理 |
| `SYNC_CONCEPT` 找不到概念使用处 | 跳过该文档，继续其他目标文件 |
| `doc-tree-evolve` Skill 输出操作引用了不存在文件 | 跳过该操作，在完成摘要中标注 |
| 用户意图过于模糊 | Skill 基于诊断结果提出 2-3 个具体方案，使用 `question` 工具让用户选择 |

---

## 流程图

```
/evolve <意图>
    │
    ▼
[阶段 0] 获取演进意图
    │ 若意图为空 → question 工具提供选项 → 追问细节
    ▼
[阶段 1] task 工具调用 doc-library-analyst SubAgent
    │ SubAgent 在独立上下文中：
    │   1.1 扫描文件元数据（路径/行数/H1/H2）
    │   1.2 读取所有文档全文 → 构建知识图谱
    │   1.3 分析方向对齐/概念一致性/覆盖缺口/结构债务
    │   1.4 输出结构化报告（library_analysis）
    │ 主 Agent 解析报告，展示扫描摘要
    ▼
[阶段 2] 调用 doc-tree-evolve Skill
    │ 传入：library_analysis + intent
    │ 输出：结构化变更计划（结构操作 + 内容操作）+ 新 index.md 草稿
    ▼
[阶段 3] 展示变更计划 → question 工具确认
    │   ├─ 全部执行 → 阶段 4
    │   ├─ 仅结构操作 → 过滤内容操作 → 阶段 4
    │   ├─ 仅低风险 → 过滤后 → 阶段 4
    │   └─ 放弃 → 输出"已取消"，终止
    ▼
[阶段 4] 按序执行操作
    │ 结构操作：CREATE_DIR → MOVE/SPLIT/MERGE/ARCHIVE → UPDATE_REFS
    │ 内容操作：UPDATE_SECTION / CREATE_FILE / SYNC_CONCEPT
    │ 最后：UPDATE_INDEX
    │ 每步输出进度
    ▼
[阶段 5] 输出完成摘要
    │
    ▼
[阶段 5.5] TODO 录入（必做）→ 专项检查 A/B + 通用检查 3 条
    │   ├─ 有项 → 读取 .opencode/skills/todo-append/SKILL.md → 按步骤追加 docs/TODO.md → 摘要列出编号
    │   └─ 零 TODO → 摘要逐条说明所有线索为何未触发（不可仅写"无项"）
```

---

## 注意事项

1. **全库视角**：始终以整个文档库为单位思考，不局限于单个文档
2. **内容第一**：方向变化时，优先更新相关文档的内容，再考虑结构调整
3. **概念一致性**：同一术语在全库中只应有一个权威定义，SYNC_CONCEPT 操作确保一致
4. **确认优先**：所有操作前必须通过阶段 3 获得用户确认，不得跳过
5. **拆分留链接**：拆分文档时，在原位置留下导航文件，链接指向各子文件
6. **移动更新引用**：移动文件时，必须更新所有引用该文件的其他文档中的路径
7. **归档不删除**：归档操作将文件移入 `docs/_archive/`，不物理删除
8. **index 最后更新**：所有文件操作和内容操作完成后才重新生成 index.md
9. **幂等设计**：多次对同一棵树执行 `/evolve` 应产生一致的结果
