---
name: evolve
description: 扫描 docs/ 文档树并执行结构演进——根据用户输入的新探索方向或结构调整需求，分析现有文档结构，生成变更计划，确认后执行拆分/合并/移动/归档等操作并更新 index.md。
---

# /evolve 命令

> **命令**：`/evolve`
> **版本**：1.0.0
> **用途**：对 docs/ 文档树进行结构性演进——转换探索方向、拆分超长文档、重新分类整理、清理断裂引用等

---

## 用法

```
/evolve <新的探索方向或结构调整需求>
```

**示例**：

```
/evolve 我现在转向研究分布式一致性协议，之前的组件平台设计暂时搁置
/evolve 文档太多了，帮我重新分类整理
/evolve 把 windows-component-platform-design.md 拆分成几个小文件
/evolve 清理一下断裂引用和孤立文档
```

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **确认优先**：所有文件操作前必须展示完整变更计划并获得用户确认，不得自动执行。

---

## 执行流程

### 阶段 0：获取用户意图

1. 从 `/evolve` 命令参数中提取用户的演进意图（即 `<新的探索方向或结构调整需求>`）
2. 若用户未提供意图（即直接输入 `/evolve` 无参数），使用 `question` 工具提问：
   - **问题**：你希望对文档结构做什么调整？
   - **选项**：
     1. 转换探索方向（开始研究新主题）
     2. 拆分超长文档
     3. 重新分类整理
     4. 清理断裂引用和孤立文档

   收到回答后，使用 `question` 工具进一步追问具体细节（如新方向是什么、要拆分哪个文件等）。

---

### 阶段 1：扫描 docs/ 树

**步骤 1.1：递归扫描文件**

扫描 `docs/` 目录下所有 `.md` 文件（排除 `index.md` 自身），对每个文件收集：

- **路径**：相对于项目根目录的路径
- **行数**：文件总行数
- **标题**：H1 标题（文件第一个 `#` 标题）
- **摘要**：文件的首段内容（H1 之后的第一段非空文字，取 1-2 句）
- **引用关系**：
  - `references`：本文件中链接到的其他 `docs/` 下的文件
  - `referenced_by`：其他文件中链接到本文件的列表

**步骤 1.2：生成诊断信息**

- **超长文档**：行数 > 300 的文件列表
- **孤立文档**：未被任何其他文档（含 index.md）引用的文件
- **断裂引用**：引用了不存在文件的链接列表
- **未收录文档**：存在于 `docs/` 但未出现在 `index.md` 文档地图中的文件

**步骤 1.3：构建快照**

将上述信息组装为 `tree_snapshot` 结构（格式见 `doc-tree-evolve` Skill 文档）。

**步骤 1.4：读取当前 index.md**

读取 `docs/index.md` 的完整内容，作为 `current_index`。

**步骤 1.5：输出扫描摘要**

向用户展示扫描结果概要：

```
---
docs/ 扫描完成

文档总数：{N} 篇
总行数：{N} 行
超长文档（>300 行）：{列表或"无"}
孤立文档：{列表或"无"}
断裂引用：{列表或"无"}
未收录文档：{列表或"无"}
---
```

---

### 阶段 2：生成演进方案

**步骤 2.1：调用 `doc-tree-evolve` Skill**

加载 `doc-tree-evolve` Skill，传入以下参数：

- `tree_snapshot`：阶段 1 构建的结构快照
- `current_index`：阶段 1 读取的当前 index.md 内容
- `intent`：阶段 0 获取的用户意图
- `max_lines`：`300`（篇幅上限）

Skill 输出结构化的变更计划，包含操作列表和新 index.md 草稿。

---

### 阶段 3：展示变更计划并确认

使用 `question` 工具向用户展示完整变更计划并请求确认：

**展示内容**：

1. **诊断结果**：超长文档、孤立文档、断裂引用等
2. **操作列表**：每个操作的类型、参数、原因、风险等级
3. **执行顺序**：操作的先后顺序

**确认交互**：

- **标题**：确认文档树变更计划
- **问题**：以上变更计划共 {N} 项操作（{操作类型统计}）。请选择操作：
- **选项**：
  1. 确认执行全部操作（Recommended）
  2. 只执行低风险操作（跳过中/高风险操作）
  3. 放弃，不做任何修改

根据用户回应：

- **选择 1（全部执行）**：继续阶段 4，执行所有操作
- **选择 2（低风险）**：过滤掉中/高风险操作，继续阶段 4
- **选择 3（放弃）**：输出 `已取消，文档树未做任何修改。` 并终止

---

### 阶段 4：执行变更

按 `doc-tree-evolve` 输出的操作顺序逐条执行：

**`CREATE_DIR`**：创建目录

```
mkdir -p {path}
```

**`MOVE_FILE`**：移动文件

1. 将文件从 `from` 移动到 `to`
2. 输出：`移动：{from} → {to}`

**`SPLIT_FILE`**：拆分文档

1. 读取源文件内容
2. 按拆分策略（通常按 H2 章节边界）拆分为多个子文件
3. 将子文件写入目标路径
4. 在原文件位置创建导航文件（保留标题 + 链接指向各子文件）
5. 输出：`拆分：{source} → {targets 列表}`

**`MERGE_FILES`**：合并文档

1. 按顺序读取所有源文件
2. 合并内容到目标文件（保持章节结构）
3. 删除源文件（确认后）
4. 输出：`合并：{sources 列表} → {target}`

**`ARCHIVE`**：归档文档

1. 创建 `docs/_archive/` 目录（若不存在）
2. 将文件移入归档目录
3. 输出：`归档：{path} → {archive_path}`

**`UPDATE_REFS`**：更新引用

1. 读取目标文件
2. 将旧引用路径替换为新引用路径
3. 写回文件
4. 输出：`更新引用：{file} 中 {old_ref} → {new_ref}`

**`UPDATE_INDEX`**：更新 index.md

1. 将 `doc-tree-evolve` 输出的新 index.md 内容写入 `docs/index.md`
2. 输出：`已更新 docs/index.md`

每个操作执行后输出进度：

```
[{当前操作序号}/{总操作数}] {操作类型}：{操作摘要}
```

---

### 阶段 5：输出完成摘要

```
---

文档树演进完成！

📊 **执行摘要**：
- 创建目录：{N} 个
- 移动文件：{N} 个
- 拆分文件：{N} 个
- 合并文件：{N} 组
- 归档文件：{N} 个
- 更新引用：{N} 处
- 更新 index.md：✓

📌 **建议后续操作**：
- 查看 `docs/index.md` 确认文档地图准确性
- 使用 `/review` 检查受影响的文档
- 若需继续调整，再次使用 `/evolve`
```

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| `docs/` 目录不存在 | 提示用户先使用 `/create` 创建文档 |
| `docs/index.md` 不存在 | 自动创建初始 index.md（仅含文件列表），继续流程 |
| 移动文件时目标路径已存在同名文件 | 使用 `question` 工具询问用户：覆盖 / 重命名 / 跳过 |
| `doc-tree-evolve` Skill 输出的操作引用了不存在的文件 | 跳过该操作，在完成摘要中标注 |
| 用户意图过于模糊 | `doc-tree-evolve` 会返回建议选项，使用 `question` 工具让用户选择 |

---

## 流程图

```
/evolve <意图>
    │
    ▼
[阶段 0] 获取用户意图
    │ 若意图为空 → question 工具提供选项 → 追问细节
    ▼
[阶段 1] 扫描 docs/ 树
    │ 递归扫描 .md 文件 → 统计行数/标题/摘要/引用
    │ 生成诊断（超长/孤立/断裂/未收录）
    │ 构建 tree_snapshot → 读取 current_index
    │ 输出扫描摘要
    ▼
[阶段 2] 调用 doc-tree-evolve Skill
    │ 传入 tree_snapshot + current_index + intent
    │ 输出变更计划 + 新 index.md 草稿
    ▼
[阶段 3] 展示变更计划 → question 工具确认
    │   ├─ 全部执行 → 继续阶段 4
    │   ├─ 仅低风险 → 过滤后继续阶段 4
    │   └─ 放弃 → 输出"已取消"，终止
    ▼
[阶段 4] 按序执行操作
    │ CREATE_DIR → MOVE/SPLIT/MERGE/ARCHIVE → UPDATE_REFS → UPDATE_INDEX
    │ 每步输出进度
    ▼
[阶段 5] 输出完成摘要
```

---

## 注意事项

1. **确认优先**：所有文件操作前必须通过阶段 3 获得用户确认，不得跳过
2. **拆分留链接**：拆分文档时，在原位置留下导航文件，链接指向新的子文件
3. **移动更新引用**：移动文件时，必须更新所有引用该文件的其他文档中的路径
4. **归档不删除**：归档操作将文件移入 `docs/_archive/`，不物理删除
5. **index 最后更新**：所有文件操作完成后才重新生成 index.md，确保文档地图准确
6. **幂等设计**：多次对同一棵树执行 `/evolve` 应产生一致的结果（前提是中间无其他变更）
