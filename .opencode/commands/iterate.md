---
name: iterate
description: 基于用户反馈迭代更新文档——读取目标文档与用户反馈，调用 doc-iterate Skill 生成修改方案，展示 diff 并请求确认，应用修改后将结果写回原文件。
---

# /iterate 命令

> **命令**：`/iterate`
> **版本**：1.0.0
> **用途**：基于反馈对文档进行定向迭代优化，精准修改目标章节，写回原文件

---

## 用法

```
/iterate <文档相对路径> <反馈内容>
```

**示例**：

```
/iterate docs/my-design.md 请补充安全章节的威胁模型分析
/iterate docs/tech-design.md 把背景章节中的 QPS 数据从 500 改为 5000，并全文统一术语"消息队列"
/iterate docs/blog-post.md 结论部分太弱，需要加强行动号召
/iterate docs/my-design.md
```

---

## 交互原则

> **重要**：在整个流程中，所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **确认优先**：在应用任何修改之前，必须向用户展示变更内容并获得确认，不得直接写入文件。

---

## 执行流程

### 阶段 0：获取参数

**步骤 0.1：提取命令参数**

命令参数（用户在命令后输入的内容）：`$ARGUMENTS`

从上述参数中提取：
- **文档路径**：第一个路径形式的参数（如 `docs/my-design.md`）
- **反馈内容**：文档路径之后的所有内容

**步骤 0.2：若未提供文档路径，使用 `question` 工具询问**

若无法从参数中提取有效文档路径，使用 `question` 工具提问：

- **标题**：指定目标文档
- **问题**：请输入要迭代的文档相对路径（如 `docs/my-design.md`）：
- **说明**：路径相对于当前工作目录，仅支持 `.md` 格式文档

**步骤 0.3：验证文件存在**

检查文件是否存在：

- 若文件**存在**：继续步骤 0.4
- 若文件**不存在**：使用 `question` 工具提示错误并请用户重新输入：
  - **标题**：文件不存在
  - **问题**：未找到文件 `{路径}`，请重新输入正确的文档路径：
  - 重复验证，直到路径有效

**步骤 0.4：若未提供反馈内容，使用 `question` 工具询问**

若未从参数中提取到反馈内容，使用 `question` 工具提问：

- **标题**：输入修改反馈
- **问题**：请描述你希望对文档做哪些修改？可以是自然语言描述（如"补充安全章节"）或具体的问题列表。

---

### 阶段 1：确认迭代选项

**步骤 1.1：询问迭代范围**

使用 `question` 工具询问迭代范围：

- **标题**：迭代范围
- **问题**：本次迭代的修改范围：
- **选项**：
  1. 仅修改反馈直接涉及的章节，不触碰其他内容（Recommended）
  2. 在修改基础上适当补充相关内容

记录 `style`：选项 1 对应 `minimal`，选项 2 对应 `enhanced`。

---

### 阶段 2：调用 `doc-iterate` Skill

加载 `doc-iterate` Skill，传入以下参数：

- `document`：阶段 0 确定的文档路径（Skill 直接从此路径读取文档内容）
- `feedback`：阶段 0 提取的用户反馈内容
- `style`：阶段 1.1 确定的值（`minimal` 或 `enhanced`）

`doc-iterate` Skill 将执行以下操作：
1. 读取文档，解析章节结构
2. 将反馈映射为具体操作（新增/修改/删除/修复等）
3. 对高风险操作（删除必需章节、大规模重组等）使用 `question` 工具向用户确认
4. 执行迭代修改，生成语义化 diff 和变更说明
5. 输出完整的修改后文档内容

---

### 阶段 3：展示变更并请求确认

`doc-iterate` 完成后，使用 `question` 工具向用户展示变更摘要并请求确认：

- **标题**：确认并应用修改
- **问题**：迭代分析完成，共有 {N} 项变更（新增 {n1}、修改 {n2}、删除 {n3}、修复 {n4}）。变更详情见上方输出。请选择操作：
- **选项**：
  1. 应用所有变更，写入 `{文档路径}`（Recommended）
  2. 放弃本次修改，保留原文件不变

根据用户回应：

- **选择 1（应用所有变更）**：继续阶段 4
- **选择 2（放弃）**：输出 `已取消，原文件未做任何修改。` 并终止

---

### 阶段 4：写入修改后文档

将 `doc-iterate` Skill 输出的"完整修改后文档"内容写入原文档路径（覆盖原文件）。

---

### 阶段 4.5：篇幅检查与 index 更新

**步骤 4.5.1：篇幅检查**

统计写入后文档的总行数。若超过 **300 行**，使用 `question` 工具提示用户：

- **标题**：文档篇幅提醒
- **问题**：修改后文档共 {N} 行，超过推荐上限（300 行）。是否需要拆分？
- **选项**：
  1. 自动拆分（调用 `/evolve` 进行文档拆分）
  2. 暂不拆分，后续再处理
  3. 手动指定拆分点（请在选择后说明）

根据用户回应：

- **选择 1（自动拆分）**：提示用户后续使用 `/evolve` 命令对该文档进行拆分
- **选择 2（暂不拆分）**：继续，不做额外操作
- **选择 3（手动指定）**：收集用户的拆分说明，提示使用 `/evolve` 并附带拆分要求

**步骤 4.5.2：更新 docs/index.md**

1. 读取 `docs/index.md`
2. 查找文档地图中对应文档的条目
3. 若文档的 H1 标题或首段摘要有实质变化，更新该条目的描述
4. 若条目不存在（文档未被收录），将其追加到合适的分类下
5. 写回 `docs/index.md`

---

### 阶段 5：输出完成摘要

写入完成后，输出完成摘要：

```
---

文档迭代完成！

📄 **文件路径**：`{文档路径}`
✏️ **本次变更**：新增 {n1} 处、修改 {n2} 处、删除 {n3} 处、修复 {n4} 处
📌 **待确认项**：{N} 个 `[待确认]` 标注需后续跟进（若无则显示"无"）

**建议后续操作**：
- 使用 `/review {文档路径}` 验证迭代后的整体质量
- 如有更多修改需求，继续使用 `/iterate {文档路径} <新反馈>` 进行迭代
```

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 文件路径不存在 | 使用 `question` 工具提示错误，请用户重新输入正确路径 |
| 文档内容为空 | 提示"文档为空，无法进行迭代"，建议使用 `/create` 生成文档 |
| 反馈内容过于模糊（如"改好一点"） | `doc-iterate` Skill 会通过 `question` 工具列出可能解读供用户澄清 |
| 文件写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |
| 用户在 Skill 执行中途取消高风险操作 | 记录已取消的操作，继续处理其余反馈项；所有操作执行完毕后进入阶段 3 |

---

## 流程图

```
/iterate <文档路径> <反馈内容>
    │
    ▼
[阶段 0] 提取文档路径 + 反馈内容
    │ 若路径为空 → question 工具询问 → 验证文件存在（循环直到有效）
    │ 若反馈为空 → question 工具询问反馈内容
    ▼
[阶段 1] 确认迭代选项
    │ 1.1 询问迭代范围（minimal / enhanced）→ question 工具
    ▼
[阶段 2] doc-iterate Skill
    │ 读取文档 → 解析反馈 → 映射操作 → 高风险操作 question 确认 → 执行修改 → 输出 diff + 完整文档
    ▼
[阶段 3] 展示变更摘要 → question 工具请求确认
    │   ├─ 应用所有变更 → 继续阶段 4
    │   └─ 放弃 → 输出"已取消"，终止
    ▼
[阶段 4] 将修改后文档写入原文件
    │
    ▼
[阶段 4.5] 篇幅检查（>300 行 → question 提示拆分）→ 更新 docs/index.md
    │
    ▼
[阶段 5] 输出完成摘要
```

---

## 注意事项

1. **确认优先**：任何修改写入文件前，必须通过阶段 3 获得用户明确确认，不得跳过
2. **最小变更默认**：默认 `style=minimal`，只修改反馈直接涉及的内容，不触碰其他章节
3. **原文件覆盖**：阶段 4 直接覆盖原文件；若用户在确认步骤选择放弃，原文件保持不变
4. **待确认项透明**：完成摘要中显示新增的 `[待确认]` 数量，提醒用户后续跟进
5. **可持续迭代**：同一文档可多次调用 `/iterate`，每次基于当前最新文件内容进行迭代
