---
name: iterate
description: 基于用户反馈迭代更新文档——读取目标文档与用户反馈，调用 doc-iterate Skill 生成修改方案，展示 diff 并请求确认，应用修改后将结果写回原文件。
---

# /iterate 命令

> **命令**：`/iterate`
> **版本**：1.0.0
> **用途**：基于反馈对文档进行定向迭代优化，精准修改目标章节，写回原文件

---

## 用法

```
/iterate <文档相对路径> <反馈内容>
```

**示例**：

```
/iterate docs/my-design.md 请补充安全章节的威胁模型分析
/iterate docs/tech-design.md 把背景章节中的 QPS 数据从 500 改为 5000，并全文统一术语"消息队列"
/iterate docs/blog-post.md 结论部分太弱，需要加强行动号召
/iterate docs/my-design.md
```

---

## 交互原则

> **重要**：在整个流程中，所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **确认优先**：在应用任何修改之前，必须向用户展示变更内容并获得确认，不得直接写入文件。

---

## 任务意识框架

在本命令执行**全程**，同时运行两种意识模式：

**主线模式**：专注理解用户反馈并高质量地完成文档修改。

**后台扫描模式**：以"文档生态守护者"的视角，持续留意以下改进信号。每次信号出现时，**即时在心智便签中标记**（不打断主流程，供末尾"TODO 录入"阶段处理）：

- 分析反馈时发现的、超出本次迭代范围的其他问题
- doc-iterate 生成的 `[待确认]`/`[假设]` 标注——**每处标注即对应一个潜在 TODO**
- 想到了"这个关联文档也应该更新"但没有处理
- 用户在追问过程中提及的、本次迭代未覆盖的后续意图

> **发现并记录改进机会，与完成核心任务同等重要。** 末尾"TODO 录入"阶段会处理这些心智便签。

---

## 执行流程

### 阶段 0：获取参数

**步骤 0.1：提取命令参数**

命令参数（用户在命令后输入的内容）：`$ARGUMENTS`

从上述参数中提取：
- **文档路径**：第一个路径形式的参数（如 `docs/my-design.md`）
- **反馈内容**：文档路径之后的所有内容

**步骤 0.2：若未提供文档路径，使用 `question` 工具询问**

若无法从参数中提取有效文档路径，使用 `question` 工具提问：

- **标题**：指定目标文档
- **问题**：请输入要迭代的文档相对路径（如 `docs/my-design.md`）：
- **说明**：路径相对于当前工作目录，仅支持 `.md` 格式文档

**步骤 0.3：验证文件存在**

检查文件是否存在：

- 若文件**存在**：继续步骤 0.4
- 若文件**不存在**：使用 `question` 工具提示错误并请用户重新输入：
  - **标题**：文件不存在
  - **问题**：未找到文件 `{路径}`，请重新输入正确的文档路径：
  - 重复验证，直到路径有效

**步骤 0.4：若未提供反馈内容，使用 `question` 工具询问**

若未从参数中提取到反馈内容，使用 `question` 工具提问：

- **标题**：输入修改反馈
- **问题**：请描述你希望对文档做哪些修改？可以是自然语言描述（如"补充安全章节"）或具体的问题列表。

---

### 阶段 0.5：智能需求探索

**目标**：在正式迭代前，根据反馈的明确程度决定追问深度，确保迭代方向准确。

**步骤 0.5.1：读取文档，建立上下文**

读取目标文档全文，提取：
- 文档整体主题、章节结构与完成状态
- 现有问题标注（`[待确认]`、`[TBD]`、`[假设]`）
- 与用户已提供反馈直接相关的章节

**步骤 0.5.2：评估反馈明确度**

根据用户反馈内容，判断意图明确度等级：

| 等级 | 判断标准 | 追问策略 | 示例 |
|------|---------|---------|------|
| **精确指令** | 反馈包含具体的修改位置+修改内容，可直接执行 | **0 轮追问**，直接进入阶段 1 | "把 QPS 从 500 改为 5000"、"删除第三章" |
| **方向明确** | 反馈指明了修改方向和范围，但需确认细节 | **1-2 轮追问**，澄清范围或优先级 | "补充安全章节的威胁模型分析"、"让结论更有力" |
| **模糊意图** | 反馈是方向性的，需要充分探索才能确定具体操作 | **充分探索**，持续追问直到意图明确 | "改好一点"、"内容太浅了" |

**步骤 0.5.3：按等级执行追问**

**精确指令**（0 轮追问）：
- 将反馈直接记录为 `requirement_notes`
- 跳过追问，直接进入步骤 0.5.4

**方向明确**（1-2 轮追问）：
- 使用 `question` 工具提出 1-2 个最关键的澄清问题（如范围、优先级、保留约束）
- 记录回答到 `requirement_notes`
- 进入步骤 0.5.4

**模糊意图**（充分探索）：
- 使用 `question` 工具逐轮追问，每轮一题，选项列表末尾保留"已经足够了，开始迭代"终止选项
- 追问维度参考（根据具体文档和反馈动态选择）：核心目标、章节优先级、质量标准、受众视角、保留约束、关联影响
- 用户选择终止后，进入步骤 0.5.4

> **`--deep` 选项**：用户在命令中附带 `--deep` 时，无论反馈明确度如何，均按"模糊意图"策略执行充分探索。

**步骤 0.5.4：生成需求复述并确认**

基于 `requirement_notes` 生成简短的需求复述（3-5 句话）：

```
需求理解确认

核心目标：{一句话描述}
主要修改方向：
- {修改重点 1}
- {修改重点 N}
特别约束：{若无则写"无"}
预期效果：{修改完成后文档应达到的状态}
```

使用 `question` 工具请求确认：
- **问题**：以上是我对本次迭代需求的理解，是否准确？
- **选项**：
  1. 理解准确，可以开始迭代（Recommended）
  2. 有偏差，需要进一步澄清

根据用户回应：
- **选择 1**：进入步骤 0.5.5
- **选择 2**：使用 `question` 工具收集澄清内容，更新 `requirement_notes`，重新生成需求复述并确认

> **精确指令跳过确认**：若步骤 0.5.2 判定为"精确指令"等级，可跳过需求复述和确认，直接进入步骤 0.5.5。

**步骤 0.5.5：询问是否需要场外 AI 协助**

使用 `question` 工具询问：

- **标题**：场外 AI 协助
- **问题**：正式迭代前，是否需要将当前问题发给场外 AI 征求参考意见？
- **选项**：
  1. 不需要，直接开始迭代（Recommended）
  2. 需要，请生成场外咨询包

根据用户回应：

- **选择 1（直接开始）**：进入阶段 1
- **选择 2（需要场外 AI）**：执行以下步骤：
  1. **生成咨询包**：以自动模式触发 `/escalate`，将文档内容、用户反馈及 `requirement_notes` 打包
  2. **引导外部操作**：输出咨询包路径
  3. **等待回答**：使用 `question` 工具询问
  4. **整合参考意见**：将场外 AI 的意见追加到 `requirement_notes`
  5. 进入阶段 1

---

### 阶段 1：确认迭代选项

**步骤 1.1：询问迭代范围**

使用 `question` 工具询问迭代范围：

- **标题**：迭代范围
- **问题**：本次迭代的修改范围：
- **选项**：
  1. 仅修改反馈直接涉及的章节，不触碰其他内容（Recommended）
  2. 在修改基础上适当补充相关内容

记录 `style`：选项 1 对应 `minimal`，选项 2 对应 `enhanced`。

---

### 阶段 2：调用 `doc-iterate` Skill

加载 `doc-iterate` Skill，传入以下参数：

- `document`：阶段 0 确定的文档路径（Skill 直接从此路径读取文档内容）
- `feedback`：阶段 0 提取的用户反馈内容 + 阶段 0.5 收集的 `requirement_notes`（含追问结论及场外 AI 参考意见，若有）
- `style`：阶段 1.1 确定的值（`minimal` 或 `enhanced`）

`doc-iterate` Skill 将执行以下操作：
1. 读取文档，解析章节结构
2. 将反馈映射为具体操作（新增/修改/删除/修复等）
3. 对高风险操作（删除必需章节、大规模重组等）使用 `question` 工具向用户确认
4. 执行迭代修改，生成语义化 diff 和变更说明
5. 输出完整的修改后文档内容

> 💡 **后台扫描触发点**：doc-iterate 执行完毕后，立即检查：是否发现了超出本次反馈范围的其他问题？修改方案中是否生成了新的 `[待确认]` 标注？是否识别出需要同步更新的关联文档？**将这些观察即时记入心智便签**，供阶段 5.5 处理。

---

### 阶段 3：展示变更并请求确认

`doc-iterate` 完成后，使用 `question` 工具向用户展示变更摘要并请求确认：

- **标题**：确认并应用修改
- **问题**：迭代分析完成，共有 {N} 项变更（新增 {n1}、修改 {n2}、删除 {n3}、修复 {n4}）。变更详情见上方输出。请选择操作：
- **选项**：
  1. 应用所有变更，写入 `{文档路径}`（Recommended）
  2. 放弃本次修改，保留原文件不变

根据用户回应：

- **选择 1（应用所有变更）**：继续阶段 4
- **选择 2（放弃）**：输出 `已取消，原文件未做任何修改。` 并终止

---

### 阶段 4：写入修改后文档

将 `doc-iterate` Skill 输出的"完整修改后文档"内容写入原文档路径（覆盖原文件）。

---

### 阶段 4.5：质量门检查（必做，不可跳过）

> 加载 `.opencode/skills/quality-gate/SKILL.md`，按其步骤执行。

**target_file**：阶段 0 确定的文档绝对路径。

质量门通过后继续阶段 4.8。

---

### 阶段 4.8：篇幅检查与 index 更新

**步骤 4.8.1：篇幅检查**

统计写入后文档的总行数。若超过 **300 行**，使用 `question` 工具提示用户：

- **标题**：文档篇幅提醒
- **问题**：修改后文档共 {N} 行，超过推荐上限（300 行）。是否需要拆分？
- **选项**：
  1. 自动拆分（调用 `/evolve` 进行文档拆分）
  2. 暂不拆分，后续再处理
  3. 手动指定拆分点（请在选择后说明）

根据用户回应：

- **选择 1（自动拆分）**：提示用户后续使用 `/evolve` 命令对该文档进行拆分
- **选择 2（暂不拆分）**：继续，不做额外操作
- **选择 3（手动指定）**：收集用户的拆分说明，提示使用 `/evolve` 并附带拆分要求

**步骤 4.8.2：更新 docs/index.md**

1. 读取 `docs/index.md`
2. 查找文档地图中对应文档的条目
3. 若文档的 H1 标题或首段摘要有实质变化，更新该条目的描述
4. 若条目不存在（文档未被收录），将其追加到合适的分类下
5. 写回 `docs/index.md`

---

### 阶段 5：输出完成摘要

写入完成后，输出完成摘要：

```
---

文档迭代完成！

📄 **文件路径**：`{文档路径}`
✏️ **本次变更**：新增 {n1} 处、修改 {n2} 处、删除 {n3} 处、修复 {n4} 处
📌 **待确认项**：{N} 个 `[待确认]` 标注需后续跟进（若无则显示"无"）

**建议后续操作**：
- 如有更多修改需求，继续使用 `/iterate {文档路径} <新反馈>` 进行迭代
```

---

### 阶段 5.5：TODO 录入（必做）

> 将心智便签中的改进信号写入 `docs/TODO.md`。

**触发线索**（逐条判断）：

1. 修改后文档中新增了 `[待确认]`/`[假设]` 标注？
2. 分析反馈时发现了超出本次迭代范围的问题？
3. 关联文档需要同步更新但未处理？
4. 用户在追问中提及了本次未覆盖的意图？
5. 篇幅检查触发了"暂不拆分"？

**对"是"项**：读取 `.opencode/skills/todo-append/SKILL.md`，按步骤追加到 `docs/TODO.md`。

**完成声明**：有记录写 `已记录 T-NNN`；零 TODO 逐条说明为何未触发。

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 文件路径不存在 | 使用 `question` 工具提示错误，请用户重新输入正确路径 |
| 文档内容为空 | 提示"文档为空，无法进行迭代"，建议使用 `/create` 生成文档 |
| 反馈内容过于模糊（如"改好一点"） | `doc-iterate` Skill 会通过 `question` 工具列出可能解读供用户澄清 |
| 文件写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |
| 用户在 Skill 执行中途取消高风险操作 | 记录已取消的操作，继续处理其余反馈项；所有操作执行完毕后进入阶段 3 |

---

## 流程图

```
/iterate <文档路径> <反馈内容>
    │
    ▼
[阶段 0] 提取文档路径 + 反馈内容
    │ 若路径为空 → question 工具询问 → 验证文件存在（循环直到有效）
    │ 若反馈为空 → question 工具询问反馈内容
    ▼
[阶段 0.5] 智能需求探索
    │ 0.5.1 读取文档，建立上下文
    │ 0.5.2 评估反馈明确度（精确指令/方向明确/模糊意图）
    │ 0.5.3 按等级追问（精确→0轮 / 方向明确→1-2轮 / 模糊→充分探索；--deep 强制充分探索）
    │ 0.5.4 生成需求复述 → question 确认（精确指令可跳过）
    │ 0.5.5 question 询问是否需要场外 AI 协助
    │         ├─ 不需要 → 进入阶段 1
    │         └─ 需要 → 触发 /escalate 自动模式 → 整合参考项 → 进入阶段 1
    ▼
[阶段 1] 确认迭代选项
    │ 1.1 询问迭代范围（minimal / enhanced）→ question 工具
    ▼
[阶段 2] doc-iterate Skill（feedback 包含 requirement_notes + 场外AI参考意见）
    │ 读取文档 → 解析反馈 → 映射操作 → 高风险操作 question 确认 → 执行修改 → 输出 diff + 完整文档
    ▼
[阶段 3] 展示变更摘要 → question 工具请求确认
    │   ├─ 应用所有变更 → 继续阶段 4
    │   └─ 放弃 → 输出"已取消"，终止
    ▼
[阶段 4] 将修改后文档写入原文件
    │
    ▼
[阶段 4.5] 质量门检查（必做）— 加载 quality-gate Skill
    │   ├─ PASS → 继续阶段 4.8
    │   └─ FAIL → 自动改进/接受/手动（最多循环 3 次）
    │
    ▼
[阶段 4.8] 篇幅检查（>300 行 → question 提示拆分）→ 更新 docs/index.md
    │
    ▼
[阶段 5] 输出完成摘要
    │
    ▼
[阶段 5.5] TODO 录入（必做）→ 判断 5 项触发线索 → 追加 TODO 或说明为何无项
```

---

## 注意事项

1. **确认优先**：任何修改写入文件前，必须通过阶段 3 获得用户明确确认，不得跳过
2. **最小变更默认**：默认 `style=minimal`，只修改反馈直接涉及的内容，不触碰其他章节
3. **原文件覆盖**：阶段 4 直接覆盖原文件；若用户在确认步骤选择放弃，原文件保持不变
4. **待确认项透明**：完成摘要中显示新增的 `[待确认]` 数量，提醒用户后续跟进
5. **可持续迭代**：同一文档可多次调用 `/iterate`，每次基于当前最新文件内容进行迭代
