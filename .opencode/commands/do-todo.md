---
name: do-todo
description: 查看或执行 docs/TODO.md 中的某一条代办事项。不带参数时展示待处理列表；带编号时以整个文档库为上下文执行该 TODO，遇到不确定事项时使用 question 工具向用户提问。
---

# /do-todo 命令

> **命令**：`/do-todo`
> **版本**：1.0.0
> **用途**：执行 `docs/TODO.md` 中的某一条代办事项——以整个文档库为上下文，充分理解背景后执行，遇到不确定事项主动向用户提问。

---

## 用法

```
/do-todo                    # 查看待处理 TODO 列表，选择要执行的项
/do-todo <编号>             # 直接执行指定编号的 TODO（如 /do-todo T-003）
```

---

## 核心理念

> `/do-todo` 不是简单地"执行一个任务"，而是**以整个文档库的视角处理一个遗留问题**。
>
> - **全局上下文**：先扫描整个文档库，理解 TODO 所在的知识网络，再动手
> - **不确定必问**：任何有疑问的地方，使用 `question` 工具向用户确认，而非臆测填充
> - **执行完标记**：TODO 执行完毕后，将其从"待处理"移入"已完成"，保持列表整洁
> - **发现新 TODO**：执行过程中发现的新代办事项，调用 `todo-append` Skill 继续记录

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文字等待用户回复。
>
> **确认优先**：对文档的修改必须展示变更内容并获得用户确认，不得自动写入。

---

## 执行流程

### 阶段 0：获取目标 TODO

**若用户未提供编号**（直接输入 `/do-todo`）：

1. 读取 `docs/TODO.md`
2. 提取所有"待处理"条目，展示列表：

```
当前待处理 TODO 列表：

  T-001 · 高优先级：{描述前 60 字}
  T-002 · 中优先级：{描述前 60 字}
  T-003 · 低优先级：{描述前 60 字}

```

3. 使用 `question` 工具询问用户选择：
   - **问题**：请选择要执行的 TODO 项
   - **选项**：[逐条列出待处理项，标注编号和优先级]

若"待处理"区域为空，输出：`docs/TODO.md 中暂无待处理项。` 并终止。

**若用户已提供编号**：直接读取 `docs/TODO.md`，定位该编号对应的条目。若编号不存在，使用 `question` 工具提示用户确认或重新选择。

---

### 阶段 1：读取 TODO 详情

读取目标 TODO 的完整内容，包括：
- **描述**：要做什么
- **来源**：由哪个命令/操作触发
- **创建时间**：何时记录
- **背景**（若有）：执行时需要知道的上下文

---

### 阶段 2：全库深度扫描

> **目的**：充分理解 TODO 所处的知识网络，避免执行时出现内容冲突或遗漏关联影响。

**步骤 2.1：扫描 docs/ 所有文档**

递归扫描 `docs/` 下所有 `.md` 文件（含 `_archive/`），对每个文件收集：
- 路径、行数、H1 标题、所有 H2 标题
- 引用关系（该文件引用哪些文件 / 被哪些文件引用）

**步骤 2.2：读取相关文档全文**

根据 TODO 的描述和背景，判断哪些文档与本次执行直接相关，逐一读取全文。

判断依据：
- TODO 描述中明确提到的文件路径
- TODO 背景中提到的关联文档
- 与 TODO 主题语义相关的文档（根据标题和章节结构判断）
- `docs/index.md`（必读，了解全局导航和当前方向）

> 若文档数量极多（>20 篇），对与 TODO 直接相关的文档读取全文，对其他文档读取 H1 + H2 标题即可。

**步骤 2.3：理解 TODO 的影响范围**

基于扫描结果，分析：
- 执行该 TODO 会直接修改哪些文件？
- 执行该 TODO 可能影响哪些文件（需要同步更新）？
- 是否存在与 TODO 描述矛盾或需要协调的现有内容？

---

### 阶段 3：制定执行计划

根据阶段 1 和阶段 2 的信息，制定执行计划：

```
TODO {编号} 执行计划
─────────────────────
目标：{TODO 描述}

将要做的事：
  1. {操作1：具体动作 + 目标文件}
  2. {操作2}
  ...

影响范围：
  - 直接修改：{文件列表}
  - 可能联动更新：{文件列表或"无"}

不确定点：{若有，列出；若无，写"无"}
```

若存在**不确定点**（信息缺失、存在多种合理方案、影响不清晰），在此阶段使用 `question` 工具逐一向用户确认，获取足够信息后再继续。

**不确定时的提问原则**：
- 每次 `question` 工具调用只问一个具体问题，不堆砌多个问题
- 提问要附带背景说明，让用户清楚为什么需要这个信息
- 对于有明确选项的问题，列出选项供用户选择；对于开放性问题，允许用户自由输入
- 若用户回答引发新的不确定，继续追问，直至信息充分

---

### 阶段 4：用户确认

使用 `question` 工具展示执行计划并请求确认：

- **标题**：确认执行 {编号}
- **问题**：以上是执行计划，请确认是否继续？
- **选项**：
  1. 确认，按计划执行（Recommended）
  2. 修改计划（我有调整意见）
  3. 取消，暂不执行

根据用户回应：
- **确认**：继续阶段 5
- **修改计划**：使用 `question` 工具询问具体调整意见，返回阶段 3 更新计划，再次确认
- **取消**：输出 `已取消，docs/TODO.md 未做修改。` 并终止

---

### 阶段 5：执行操作

按计划逐项执行。每项操作完成后输出进度：

```
[{当前序号}/{总操作数}] {操作摘要}：完成
```

**常见操作类型**：

| 操作类型 | 执行方式 |
|---------|---------|
| 在现有文档中补充内容 | 读取文件 → 定位目标章节 → 编辑内容 → 写回 |
| 新建文档 | 按大纲生成内容 → 写入目标路径 |
| 重写文档某一章节 | 读取文件 → 替换目标章节 → 写回 |
| 跨文档同步内容 | 确定权威来源 → 在各目标文档中更新相应位置 |
| 修改 index.md 导航 | 读取 index.md → 更新目录表和目录结构 → 写回 |

> **若执行过程中发现新的代办事项**（超出本次 TODO 范围的内容），调用 `todo-append` Skill 记录，不打断当前执行。

---

### 阶段 6：标记 TODO 完成

操作全部执行完毕后，更新 `docs/TODO.md`：

1. 将目标条目从"待处理"区域**移动**到"已完成"区域
2. 在条目末尾追加完成信息：
   ```
   **完成**：{今日日期}
   **完成说明**：{用一两句话说明做了什么，或"按计划执行完毕"}
   ```
3. 若"待处理"区域移除所有条目后为空，替换为 `*(暂无待处理项)*`
4. 更新文件末尾的 `*最后更新：{日期}*`

---

### 阶段 7：输出完成摘要

```
---

TODO {编号} 执行完成！

📄 **变更文件**：
{列出所有修改的文件}

📝 **执行说明**：
{对本次执行的简要说明，1-3 句话}

📌 **建议后续**：
{若有自然延伸的后续操作，给出建议；若无，写"无"}
---
```

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| `docs/TODO.md` 不存在 | 提示用户该文件不存在，建议先通过其他命令触发 TODO 记录 |
| 指定编号不存在 | 展示当前待处理列表，使用 `question` 工具让用户重新选择 |
| 待处理列表为空 | 输出提示并终止，不继续执行 |
| 执行过程中目标文件不存在 | 使用 `question` 工具询问用户：创建文件 / 跳过 / 取消 |
| 执行过程中遇到内容冲突 | 使用 `question` 工具展示冲突详情，让用户裁决 |
| TODO 描述不清晰，无法确定执行方案 | 使用 `question` 工具向用户补充询问，获取足够信息再行动 |

---

## 流程图

```
/do-todo [编号]
    │
    ▼
[阶段 0] 确定目标 TODO
    │ 若无编号 → 展示列表 → question 工具选择
    │ 若有编号 → 读取该条目
    ▼
[阶段 1] 读取 TODO 详情（描述 / 来源 / 背景）
    ▼
[阶段 2] 全库深度扫描
    │ 2.1 扫描 docs/ 元数据
    │ 2.2 读取相关文档全文
    │ 2.3 分析影响范围
    ▼
[阶段 3] 制定执行计划
    │ 若有不确定点 → question 工具逐一提问 → 信息充分后继续
    ▼
[阶段 4] question 工具确认计划
    │   ├─ 确认 → 阶段 5
    │   ├─ 修改 → 回阶段 3
    │   └─ 取消 → 输出"已取消"，终止
    ▼
[阶段 5] 执行操作（逐项，输出进度）
    │ 发现新代办 → 调用 todo-append Skill 记录
    ▼
[阶段 6] 标记 TODO 完成（移入"已完成"区域）
    ▼
[阶段 7] 输出完成摘要
```

---

## 注意事项

1. **全局视角优先**：执行前必须扫描全库，避免遗漏关联影响
2. **不确定必问**：绝不基于猜测执行——任何信息不足都应通过 `question` 工具补充
3. **执行后标记**：完成后必须更新 `docs/TODO.md`，保持列表整洁可信
4. **发现即记录**：执行中发现的新代办事项，用 `todo-append` 记录，不跳过、不搁置
5. **修改需确认**：对任何文档的实质性修改，必须先展示变更内容并获得用户确认
6. **一次一个**：每次执行一条 TODO，不批量处理，确保每条都执行到位
