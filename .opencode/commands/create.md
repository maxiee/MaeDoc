---
name: create
description: 一键创建新文档——MaeDoc 最核心的用户入口。解析用户意图，匹配文档类型，通过大纲确认和内容填充流程，最终将格式化后的完整文档输出到 docs/ 目录。
---

# /create 命令

> **命令**：`/create`
> **版本**：1.0.0
> **用途**：一键启动文档创建流水线，从用户的一句话想法到完整的结构化文档

---

## 用法

```
/create <文档想法描述>
```

**示例**：

```
/create 我想写一篇关于微服务架构的技术设计文档
/create 帮我写一篇介绍 Rust 所有权机制的博客文章
/create 写一个通用文档，记录我们团队的 API 设计规范
```

---

## 执行流程

### 阶段 0：准备

1. 从 `/create` 命令参数中提取用户的想法描述（即 `<文档想法描述>`）
2. 若用户未提供描述（即直接输入 `/create` 无参数），提示用户补充：
   ```
   请告诉我你想写什么文档？例如：
   /create 我想写一篇关于 Kubernetes 迁移的技术设计文档
   ```
   然后等待用户输入，不继续后续步骤。

---

### 阶段 1：文档类型匹配

**步骤 1.1：扫描可用文档类型**

读取以下目录下所有文档类型定义：

```
docs/_templates/*/type.json
```

提取每个类型的 `type_id`、`name`、`description`、`tags` 字段，构建可用类型列表。

**步骤 1.2：意图分析与类型匹配**

基于用户描述，分析意图并匹配最合适的文档类型：

| 意图特征 | 匹配类型 |
|---------|---------|
| 包含"技术设计"、"架构"、"方案"、"系统设计"、"Tech Design" | `tech-design` |
| 包含"博客"、"文章"、"科普"、"教程"、"Blog" | `blog-post` |
| 其他（无法明确匹配特定类型时） | `generic` |

**步骤 1.3：向用户确认文档类型**

输出匹配结果并请用户确认：

```
根据你的描述，我建议使用以下文档类型：

📄 **{类型名称}**（`{type_id}`）
{类型描述}

可用类型完整列表：
{列出所有可用类型：序号. 类型名称（type_id）- 一句话描述}

✅ 是否使用推荐类型「{类型名称}」？或请输入其他类型的序号/type_id：
```

等待用户确认或选择其他类型。若用户确认推荐类型，继续；若用户指定其他类型，更新 `doc_type`。

---

### 阶段 2：大纲生成

**步骤 2.1：调用 `doc-outline-generate` Skill**

加载 `doc-outline-generate` Skill，传入以下参数：

- `idea`：用户的想法描述
- `doc_type`：已确认的文档类型 `type_id`
- `extra_constraints`：（如有）用户在描述中提到的额外约束

执行大纲生成，输出结构化大纲。

**步骤 2.2：大纲交互确认**

大纲生成完毕后，向用户呈现大纲并请求确认：

```
---

✅ 大纲已生成，请确认后继续：

{展示生成的大纲内容}

---

请选择下一步操作：
1. ✅ **确认大纲，开始填充内容**
2. ✏️  **修改大纲**（请说明需要调整的内容）
3. 🔄 **重新生成大纲**（请补充更多背景信息）
4. ❌ **放弃**
```

根据用户回应：

- **选择 1（确认）**：继续阶段 3
- **选择 2（修改）**：收集用户修改意见，更新大纲，再次呈现确认
- **选择 3（重新生成）**：收集更多背景信息，重新调用 `doc-outline-generate`，再次呈现确认
- **选择 4（放弃）**：输出 `已取消文档创建流程。` 并终止

---

### 阶段 3：内容填充

**步骤 3.1：调用 `doc-content-fill` Skill**

加载 `doc-content-fill` Skill，传入以下参数：

- `outline`：阶段 2 确认的最终大纲
- `doc_type`：文档类型 `type_id`
- `materials`：用户在对话中提供的任何素材（背景资料、数据、代码片段等）
- `constraints`：用户指定的额外约束（语言风格、目标长度等）

执行内容填充，输出完整文档内容。

**步骤 3.2：内容填充进度提示**

每开始填充一个章节时，输出进度提示：

```
正在填充：## {章节标题}（{当前章节序号}/{总章节数}）
```

---

### 阶段 4：格式规范化

**步骤 4.1：调用 `doc-format-normalize` Skill**

加载 `doc-format-normalize` Skill，传入以下参数：

- `document`：阶段 3 生成的完整文档内容
- `dry_run`：`false`（直接写入，后续由命令负责保存文件）

执行格式规范化，获取格式化后的文档内容。

---

### 阶段 5：输出文档

**步骤 5.1：确定输出文件名**

基于以下规则生成文件名：

1. 若文档标题已确定（非「待确认」）：将标题转换为 kebab-case 文件名
   - 中文标题：提取关键词转为拼音或英文缩写（若无法确定，使用类型 ID）
   - 示例：「微服务架构迁移设计」→ `microservice-migration-design.md`
2. 若标题未确定：使用 `{type_id}-{当前日期 YYYYMMDD}.md`
   - 示例：`tech-design-20240115.md`
3. 若文件名已存在：追加序号后缀，如 `tech-design-20240115-2.md`

**步骤 5.2：写入文件**

将格式化后的完整文档写入 `docs/{文件名}`。

**步骤 5.3：输出完成摘要**

```
---

🎉 文档创建完成！

📄 **文件路径**：`docs/{文件名}`
📋 **文档类型**：{类型名称}（`{type_id}`）
📊 **文档概况**：共 {N} 个章节，约 {N} 字

**各章节信心等级**：
{从填充摘要中提取的信心等级表}

**遗留待确认项**（共 {N} 项）：
{从填充摘要中提取的待确认项列表，若无则显示"无"}

---

📌 **建议后续操作**：
- 使用 `/review docs/{文件名}` 进行全面审阅
- 使用 `/iterate docs/{文件名} <反馈>` 进行定向优化
- 使用 `/audit docs/{文件名}` 运行质量全套检查
```

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| `docs/_templates/` 目录不存在或无任何 `type.json` | 提示"未找到文档类型定义，请确认 MaeDoc 仓库结构完整"，终止流程 |
| 指定的 `type_id` 不存在 | 列出可用类型，请用户重新选择 |
| 大纲生成失败（Skill 执行异常） | 提示异常原因，建议补充更多背景信息后重试 |
| `docs/` 目录不存在 | 询问用户是否创建该目录，确认后创建再写入 |
| 文件写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |

---

## 流程图

```
/create <描述>
    │
    ▼
[阶段 0] 提取用户描述
    │ 若描述为空 → 提示补充 → 等待输入
    ▼
[阶段 1] 扫描可用文档类型 → 意图匹配 → 确认文档类型
    │ 用户确认 / 选择其他类型
    ▼
[阶段 2] doc-outline-generate → 输出大纲 → 用户确认
    │ 确认 / 修改 / 重新生成
    ▼
[阶段 3] doc-content-fill → 逐章节填充 → 输出完整文档
    │
    ▼
[阶段 4] doc-format-normalize → 格式规范化
    │
    ▼
[阶段 5] 写入 docs/{文件名} → 输出完成摘要
```

---

## 注意事项

1. **交互优先**：每个关键决策节点（类型确认、大纲确认）必须等待用户响应，不得跳过
2. **不阻塞原则**：大纲和内容中的未知信息用 `[待确认: ...]` 占位，不因信息缺失而暂停整个流程
3. **权限意识**：写入 `docs/` 目录前，遵循 `opencode.jsonc` 中 `edit` 权限配置；若需要询问，先询问再执行
4. **幂等设计**：若目标文件已存在，不直接覆盖，改用带序号的新文件名，并告知用户
5. **上下文携带**：整个流程在同一会话上下文中执行，各阶段的中间产物（大纲、填充摘要）在后续阶段中可引用
