---
name: create
description: 一键创建新文档——MaeDoc 最核心的用户入口。与用户简短对话，AI 根据内容性质自主判断文档结构，直接生成并落盘，后续可通过 /iterate 持续演化。
---

# /create 命令

> **命令**：`/create`
> **版本**：2.0.0
> **用途**：从用户的一句话描述，自由创建结构化文档——AI 根据内容自主决定结构，不套模板

---

## 用法

```
/create <文档想法描述>
```

**示例**：

```
/create 我想整理一下对分布式系统 CAP 理论的理解
/create 记录今天关于微服务拆分的架构决策
/create 写一篇介绍 Rust 所有权机制的文章
```

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。`question` 工具能在不退出当轮对话的情况下收集用户输入，保持流程连续性。

---

## 任务意识框架

在本命令执行**全程**，同时运行两种意识模式：

**主线模式**：专注高质量完成每个阶段的核心任务。

**后台扫描模式**：以"文档生态守护者"的视角，持续留意以下改进信号。每次信号出现时，**即时在心智便签中标记**（不打断主流程，供末尾"TODO 录入"阶段处理）：

- 写了 `[待确认]`/`[TBD]`/`[假设]` 的位置——**每处标注就是一个潜在 TODO**
- 因"超出范围"、"信息不足"、"时机不对"而跳过或简化的步骤
- 注意到某个关联文档/章节也需要更新，但不在本次任务范围内
- 用户在对话中顺带提到了后续意图，但本次不会处理

> **发现并记录改进机会，与完成核心任务同等重要。** 末尾"TODO 录入"阶段会处理这些心智便签。

---

## 文件优先原则

> **核心设计**：从大纲阶段开始，**每一步的输出都直接写入磁盘文件**。各阶段 Skill 对同一个文件进行修改，而非在上下文中积累内容最后一次性落盘。这样用户可以在创建过程中随时查看文件的当前状态。

---

## 执行流程

### 阶段 0：准备

1. 从 `/create` 命令参数中提取用户的想法描述（即 `<文档想法描述>`）
2. 若用户未提供描述（即直接输入 `/create` 无参数），使用 `question` 工具提问：
   - **问题**：你想写什么文档？
   - **选项**：用户自由输入（可提示示例：对某个概念的理解整理、架构决策记录、技术调研笔记等）

   收到回答后继续后续步骤。

---

### 阶段 0.5：深化需求探询

> **目标**：在生成大纲之前，通过简短对话充分了解用户需求，积累的问答记录将作为 `enriched_context` 传入后续阶段。

**执行规则**：

1. 基于用户的初始描述，推断出最有价值的第一个追问（例如：目标读者是谁、核心诉求是什么、有哪些已知限制等）。
2. 使用 `question` 工具提出问题，**选项列表的最后一项始终保留**：
   - `已经足够了，开始生成大纲`（终止选项）
3. 若用户**未选择**终止选项：
   - 记录本轮问答（`Q: {问题} / A: {回答}`）
   - 根据已有回答推断下一个最有价值的追问，再次调用 `question` 工具（仍保留终止选项）
   - 如此循环，**无次数上限**，直到用户主动终止
4. 若用户**选择**终止选项：
   - 将本轮所有问答汇总为 `enriched_context`，格式如下：

     ```
     原始描述：{用户最初的想法}

     补充信息：
     - Q: {问题1} → A: {回答1}
     - Q: {问题2} → A: {回答2}
     …
     ```

   - 继续阶段 1，后续所有阶段使用 `enriched_context` 替代单纯的原始描述

**追问方向参考**（根据内容和已有信息灵活选择，不必按顺序）：

| 维度 | 示例问题 |
|------|---------|
| 目标读者 | 这篇文档主要写给谁看？（自己备忘 / 团队内部 / 外部读者） |
| 核心目标 | 你最希望读者读完后能得到什么？ |
| 内容边界 | 有哪些内容**一定要包含**？有哪些**不需要覆盖**？ |
| 已有素材 | 你有现成的草稿、参考资料或要点可以提供吗？ |
| 风格偏好 | 偏好正式严谨的技术风格，还是轻松易读的风格？ |
| 长度预期 | 期望文档大概多长？（简短摘要 / 中等篇幅 / 详尽全面） |
| 特殊约束 | 有没有格式、语言或发布平台方面的限制？ |

> **注意**：每次追问应优先选择在当前上下文中信息增益最大的维度，避免重复提问已明确的内容。

---

### 阶段 1：确定输出文件路径

> **重要**：在生成大纲之前先确定文件路径，后续所有阶段都对同一文件进行读写操作。

**步骤 1.1：生成文件名**

基于以下规则生成文件名：

1. 根据用户描述中的关键词，生成语义化英文文件名（kebab-case）
   - 中文描述：提取核心主题词，转为英文或拼音缩写
   - 示例：「分布式系统 CAP 理论」→ `cap-theorem-notes.md`
2. 若无法提取有效关键词：使用 `doc-{当前日期 YYYYMMDD}.md`
   - 示例：`doc-20240115.md`
3. 若文件名已存在：追加序号后缀，如 `cap-theorem-notes-2.md`

**步骤 1.2：确认 docs/ 目录**

> **docs 结构标准**：遵循 `maedoc/docs-structure-standard.md` 的定义。

检查 `docs/` 目录是否存在：
- 若不存在：使用 `question` 工具询问用户是否创建该目录，确认后创建
- 若已存在：直接使用

**步骤 1.3：路径深度判断**

基于 `enriched_context`，判断新文档是否属于某个已有分类：

1. 读取 `docs/index.md` 的文档地图，获取现有分类列表
2. 若能识别出文档属于某个已有分类（如该分类已有对应子目录），路径使用子目录：
   - 示例：文档关于 CAP 理论，已有 `docs/distributed-systems/` 目录 → `docs/distributed-systems/cap-theorem.md`
3. 若无法归入已有分类，放在 `docs/` 根目录

**步骤 1.4：记录输出路径**

将 `output_file = docs/{文件名}` 作为变量，在后续所有阶段中引用。输出告知用户：

```
📁 文档将保存至：docs/{文件名}
```

同时，根据 `output_file` 推导 `base_dir` 候选路径（供多文件模式使用）：
- 若 `output_file` 在 `docs/` 根目录（如 `docs/my-topic.md`）：`base_dir = docs/my-topic/`
- 若 `output_file` 已在子目录（如 `docs/cross-platform-setup/my-topic.md`）：`base_dir = docs/cross-platform-setup/`（使用其父目录）

`base_dir` 此时仅作候选记录，实际创建形式由阶段 2.2 的用户确认决定。

---

### 阶段 2：大纲生成

**步骤 2.1：调用 `doc-outline-generate` Skill**

加载 `doc-outline-generate` Skill，传入以下参数：

- `idea`：阶段 0.5 汇总的 `enriched_context`（包含原始描述 + 所有追问回答）；若用户跳过追问则使用原始描述
- `extra_constraints`：（如有）用户在描述或追问回答中提到的额外约束
- `output_file`：阶段 1 确定的文件路径

> **注意**：AI 根据内容的性质自主决定文档结构，不依赖预设模板。思考"这份内容最适合什么形式呈现"，而非"套用哪个模板"。

执行大纲生成。**`doc-outline-generate` 会在生成大纲后立即将大纲内容写入 `output_file`**，无需本命令再次写入。

**步骤 2.2：大纲交互确认**

大纲生成并写入文件完毕后，读取大纲中的**规模评估**（`## 规模评估` 部分），获取"建议形式"字段：

**若"建议形式"为"多文件文档树"**，使用 `question` 工具：

- **标题**：确认文档大纲与创建形式
- **问题**：大纲已生成并保存至 `{output_file}`，规模评估建议以多文件文档树形式创建（预估 ~{N} 行，超出单文档 300 行上限）。请选择创建形式：
- **选项**：
  1. 以多文件文档树形式创建（Recommended）
  2. 改为单文件创建（不拆分）
  3. 修改大纲（请在选择后说明需要调整的内容）
  4. 重新生成大纲（请在选择后补充更多背景信息）
  5. 放弃

根据用户回应：

- **选择 1（多文件）**：记录 `creation_mode = multi_file`，继续阶段 3-B
- **选择 2（单文件）**：记录 `creation_mode = single_file`，继续阶段 3-A
- **选择 3（修改）**：收集用户修改意见，更新大纲并重新写入 `output_file`，再次执行步骤 2.2
- **选择 4（重新生成）**：使用 `question` 工具收集更多背景信息，重新调用 `doc-outline-generate`（附带 `output_file`），再次执行步骤 2.2
- **选择 5（放弃）**：输出 `已取消文档创建流程。` 并终止

**若"建议形式"为"单文件"**，使用 `question` 工具：

- **标题**：确认文档大纲
- **问题**：大纲已生成并保存至 `{output_file}`（见上方输出），请选择下一步操作：
- **选项**：
  1. 确认大纲，开始填充内容（Recommended）
  2. 修改大纲（请在选择后说明需要调整的内容）
  3. 重新生成大纲（请在选择后补充更多背景信息）
  4. 放弃

根据用户回应：

- **选择 1（确认）**：记录 `creation_mode = single_file`，继续阶段 3-A
- **选择 2（修改）**：收集用户修改意见，更新大纲并重新写入 `output_file`，再次执行步骤 2.2
- **选择 3（重新生成）**：使用 `question` 工具收集更多背景信息，重新调用 `doc-outline-generate`（附带 `output_file`），再次执行步骤 2.2
- **选择 4（放弃）**：输出 `已取消文档创建流程。` 并终止

---

### 阶段 3：内容填充

根据阶段 2.2 确认的 `creation_mode`，执行对应的填充流程：

---

#### 阶段 3-A：单文件填充（`creation_mode = single_file`）

**步骤 3-A.1：调用 `doc-content-fill` Skill**

加载 `doc-content-fill` Skill，传入以下参数：

- `output_file`：阶段 1 确定的文件路径（Skill 从此文件读取大纲，并逐章节将内容写回此文件）
- `materials`：用户在对话中提供的任何素材（背景资料、数据、代码片段等）
- `constraints`：用户指定的额外约束（语言风格、目标长度等）
- `max_lines`：`300`

**`doc-content-fill` 直接操作 `output_file`**：从文件读取大纲，逐章节填充内容后写回文件，文件在此过程中持续更新。

**步骤 3-A.2：内容填充进度提示**

每开始填充一个章节时，输出进度提示：

```
正在填充：## {章节标题}（{当前章节序号}/{总章节数}）→ 已写入 {output_file}
```

> 💡 **后台扫描触发点**：每次填充完一个章节，若写下了 `[待确认]`/`[假设]` 标注，或因信息不足而简化了该章节的内容，立即在心智便签中记一笔（章节名 + 简要原因）。这是整个创建流程中产生 TODO 候选项最密集的阶段。

---

#### 阶段 3-B：多文件文档树填充（`creation_mode = multi_file`）

**步骤 3-B.1：确认 `base_dir` 并清理临时大纲文件**

使用阶段 1.4 推导的 `base_dir` 候选路径。

删除 `output_file`（该文件仅用于存储草稿大纲，多文件模式下由 `doc-tree-fill` 在 `base_dir` 内创建正式文件）。

**步骤 3-B.2：调用 `doc-tree-fill` Skill**

加载 `doc-tree-fill` Skill，传入以下参数：

- `tree_plan`：阶段 2 大纲中的"建议的文档树结构"部分（各子文档文件名、标题、覆盖章节、预估行数）
- `base_dir`：步骤 3-B.1 确认的目录路径
- `original_idea`：阶段 0.5 汇总的 `enriched_context`
- `materials`：用户在对话中提供的任何素材
- `constraints`：用户指定的额外约束
- `max_lines_per_doc`：`300`

**`doc-tree-fill` 在 `base_dir` 下逐子文档创建文件、生成大纲、填充内容，最后生成 `{base_dir}/index.md` 作为导航入口**。

---

### 阶段 4：格式规范化

**步骤 4.1：调用 `doc-format-normalize` Skill**

加载 `doc-format-normalize` Skill：

- **单文件模式**：传入 `document = output_file`，`dry_run = false`
- **多文件模式**：对 `base_dir` 下每个填充完成的 `.md` 文件（含 `index.md`）依次调用，确保所有子文档格式统一

**`doc-format-normalize` 直接读取文件，完成格式修正后写回同一文件**。

---

### 阶段 5：输出完成摘要

> 此时文档已就绪：单文件模式下 `output_file` 包含完整文档；多文件模式下 `base_dir/` 包含所有子文档和导航入口。

**步骤 5.1：输出完成摘要**

**单文件模式（`creation_mode = single_file`）**：

```
---

文档创建完成！

📄 **文件路径**：`{output_file}`
📊 **文档概况**：共 {N} 个章节，约 {N} 字

**各章节信心等级**：
{从填充摘要中提取的信心等级表}

**遗留待确认项**（共 {N} 项）：
{从填充摘要中提取的待确认项列表，若无则显示"无"}

---

📌 **建议后续操作**：
- 使用 `/review {output_file}` 进行全面审阅
- 使用 `/iterate {output_file} <反馈>` 进行定向优化
```

**多文件模式（`creation_mode = multi_file`）**：

```
---

文档树创建完成！

📁 **文档目录**：`{base_dir}`
📄 **文件清单**：（来自 doc-tree-fill 完成摘要）

---

📌 **建议后续操作**：
- 查看 `{base_dir}/index.md` 确认导航结构
- 使用 `/review {base_dir}/index.md` 进行整体审阅
- 使用 `/evolve` 对文档树进行后续结构调整
```

---

### 阶段 6：更新 docs/index.md

> 将新创建的文档登记到入口文档的文档地图中。
> **docs 结构标准**：`docs/index.md` 是全库导航枢纽，所有新文档必须在此注册（`maedoc/docs-structure-standard.md §2`）。

**步骤 6.1：读取当前 index.md**

读取 `docs/index.md` 的完整内容。若 `docs/index.md` 不存在，使用初始模板创建。

**步骤 6.2：追加到文档地图**

1. 根据文档内容判断应归入哪个分类
2. 若文档地图中已有匹配的分类，在该分类表格末尾追加一行：
   - **单文件模式**：`| [文档标题](./相对路径) | 一句话描述 |`
   - **多文件模式**：`| [文档标题](./{base_dir}/index.md) | 一句话描述（多文档集合，含 N 个子文档）|`
3. 若无匹配分类，创建新的分类标题（H3）并添加条目
4. 更新目录结构树

**步骤 6.3：写回 index.md**

将更新后的内容写回 `docs/index.md`，更新末尾的最后更新时间。

输出：

```
已将 {文档/文档树} 添加到 docs/index.md 文档地图。
```

---

### 阶段 7：TODO 录入（必做）

> 将执行全程心智便签中的改进信号写入全局 TODO 列表，供后续专项处理。**忠实记录真实发现的改进机会，是本次任务执行质量的体现。**

**步骤 1：回顾心智便签，逐条判断以下具体触发线索**

| # | 本次执行的具体线索（对照实际执行回答，而非抽象假设） | 结论 |
|---|---|:---:|
| 1 | 内容填充（阶段 3）中，有无章节因信息不足写了 `[待确认]`/`[假设]`/`[TBD]` 标注？ | 是 / 否 |
| 2 | 某章节的主题在本文档中仅浅覆盖，值得后续单独深化或撰写专题文档？ | 是 / 否 |
| 3 | 注意到现有文档（index.md 外的其他文档）需要更新或同步引用，但本次未处理？ | 是 / 否 |
| 4 | 用户在阶段 0.5 深化探询中提及了本次文档未覆盖的后续意图或关切？ | 是 / 否 |
| 5 | 多文件模式下有子文档内容被简化；或单文件模式下有章节因时间/范围原因降级处理？ | 是 / 否 |

**步骤 2：对每个"是"项执行**（每项单独处理，不可合并省略）

1. 读取 `.opencode/skills/todo-append/SKILL.md`
2. 按 Skill 步骤将事项追加到 `docs/TODO.md`（填写 description/source/priority/background）
3. 在完成摘要中记录编号（如 `已记录 T-005`）

**步骤 3：完成声明（必须出现在完成摘要中，二选一）**

- **有 TODO 记录**：列出所有已记录编号，如 `已记录 T-005, T-006`
- **零 TODO**：对上表 5 条线索，每条用一句话说明本次执行中为何未触发。不可仅写"TODO 扫描：无项"而不解释。

> 提示：多阶段创建任务中，5 条全不触发是少见情况。若某条线索难以简短解释"为何不触发"，往往意味着那里确有值得记录的事项。

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 大纲生成失败（Skill 执行异常） | 提示异常原因，建议补充更多背景信息后重试 |
| `docs/` 目录不存在 | 使用 `question` 工具询问用户是否创建该目录，确认后创建再写入 |
| 文件写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |
| 大纲写入文件后用户放弃 | 删除已创建的文件，或保留（由用户选择） |

---

## 流程图

```
/create <描述>
    │
    ▼
[阶段 0] 提取用户描述
    │ 若描述为空 → 使用 question 工具提问 → 收到回答后继续
    ▼
[阶段 0.5] 深化需求探询（持续追问循环）
    │ question 工具提问（末尾保留"已经足够了，开始生成大纲"选项）
    │   ├─ 用户未选终止 → 记录问答 → 推断下一追问 → 继续循环
    │   └─ 用户选终止  → 汇总 enriched_context → 继续
    ▼
[阶段 1] 确定输出文件路径 → 创建 docs/ 目录（如需）→ 判断路径深度 → 记录 output_file + base_dir 候选
    │
    ▼
[阶段 2] doc-outline-generate（传入 enriched_context，AI 自主决定结构 + 规模评估）→ 写入 output_file
    │
    ▼
[阶段 2.2] 读取规模评估"建议形式"
    │   ├─ 多文件文档树 → question（5 选项：多文件推荐/单文件/修改/重新生成/放弃）
    │   │     ├─ 选多文件 → creation_mode = multi_file
    │   │     ├─ 选单文件 → creation_mode = single_file
    │   │     ├─ 修改/重新生成 → 更新大纲 → 重新执行 2.2
    │   │     └─ 放弃 → 终止
    │   └─ 单文件 → question（4 选项：确认/修改/重新生成/放弃）
    │         ├─ 确认 → creation_mode = single_file
    │         ├─ 修改/重新生成 → 更新大纲 → 重新执行 2.2
    │         └─ 放弃 → 终止
    ▼
[阶段 3] 内容填充
    │   ├─ single_file → [3-A] doc-content-fill（max_lines=300）→ 逐章节填充 → 写回 output_file
    │   └─ multi_file  → [3-B] 删除临时 output_file → doc-tree-fill（base_dir, tree_plan）
    │                          → 逐子文档（doc-outline-generate + doc-content-fill）
    │                          → 生成 base_dir/index.md
    ▼
[阶段 4] doc-format-normalize → 单文件：规范 output_file；多文件：逐一规范 base_dir/*.md
    │
    ▼
[阶段 5] 输出完成摘要（单文件：文件路径+章节信心；多文件：目录+文件清单）
    │
    ▼
    ▼
[阶段 6] 更新 docs/index.md → 追加文档地图条目（单文件链接文档；多文件链接 base_dir/index.md）
    │
    ▼
[阶段 7] TODO 录入（必做）→ 回顾心智便签，逐条判断 5 项具体触发线索
    │   ├─ 有"是" → 读取 .opencode/skills/todo-append/SKILL.md → 按步骤追加 docs/TODO.md → 摘要列出编号
    │   └─ 零 TODO → 摘要逐条说明 5 条线索为何未触发（不可仅写"无项"）
```

---

## 注意事项

1. **文件优先**：`output_file` 在阶段 1 确定后贯穿全流程，所有 Skill 都操作同一文件（单文件模式）；多文件模式下以 `base_dir` 为根，各子文档独立操作
2. **交互优先**：大纲确认等关键决策节点必须等待用户响应，不得跳过
3. **不阻塞原则**：大纲和内容中的未知信息用 `[待确认: ...]` 占位，不因信息缺失而暂停整个流程
4. **权限意识**：写入 `docs/` 目录前，遵循 `opencode.jsonc` 中 `edit` 权限配置；若需要询问，先询问再执行
5. **幂等设计**：若目标文件已存在，不直接覆盖，改用带序号的新文件名，并告知用户
6. **自由结构**：AI 根据内容自主判断最合适的文档结构，不依赖预设模板；同一个 `/create` 命令对不同主题可能产生完全不同的章节组织
7. **规模优先**：对于预估超出 300 行的主题，优先建议多文件文档树形式；不强迫用户选择，但应主动说明单文件的超限风险（详见 `maedoc/docs-structure-standard.md §3`）
8. **临时文件清理**：多文件模式下，阶段 3-B 会删除阶段 1-2 创建的临时大纲文件（`output_file`），确保 `base_dir` 下的文件是唯一的正式版本
