---
name: review
description: 对现有文档进行全面审阅——依次调用结构审计（doc-structure-audit）、质量评分（doc-quality-score）、内容审阅（doc-review）三个 Skill，输出综合审阅报告。需要用户输入文档的相对路径；审阅过程中遇到任何不确定之处均通过 question 工具提问。
---

# /review 命令

> **命令**：`/review`
> **版本**：1.0.0
> **用途**：对现有文档进行全面审阅，包含结构审计、质量评分、内容审阅，输出综合报告

---

## 用法

```
/review <文档相对路径>
```

**示例**：

```
/review docs/my-design.md
/review docs/tech-design-20240115.md
/review
```

---

## 交互原则

> **重要**：在整个流程中，所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。
>
> **提问优先**：遇到任何拿不准的地方，立即通过 `question` 工具提问，不做假设性推断，提问次数不设上限。

---

## 执行流程

### 阶段 0：获取文档路径

**步骤 0.1：提取命令参数**

命令参数（用户在命令后输入的内容）：`$ARGUMENTS`

从上述参数中提取文档路径（相对路径，如 `docs/my-design.md`）。若 `$ARGUMENTS` 为空，则视为未提供路径，进入步骤 0.2。

**步骤 0.2：若未提供路径，使用 `question` 工具询问**

若用户未提供路径（即直接输入 `/review` 无参数），使用 `question` 工具提问：

- **标题**：指定审阅文档
- **问题**：请输入要审阅的文档相对路径（如 `docs/my-design.md`）：
- **说明**：路径相对于当前工作目录，仅支持 `.md` 格式文档

**步骤 0.3：验证文件存在**

检查文件是否存在：

- 若文件**存在**：继续阶段 1
- 若文件**不存在**：使用 `question` 工具提示错误，并请用户重新输入：
  - **标题**：文件不存在
  - **问题**：未找到文件 `{路径}`，请重新输入正确的文档路径：
  - 重复验证，直到文件路径有效为止

---

### 阶段 1：了解审阅需求

#### 步骤 1.1：确认文档类型

读取文档内容，扫描 `docs/_templates/*/type.json`，尝试从文档内容（标题结构、关键词）自动推断文档类型。

**情形 A：可以明确推断文档类型**

使用 `question` 工具向用户确认：

- **标题**：确认文档类型
- **问题**：根据文档内容，判断这是一篇「{类型名称}」（`{type_id}`）——{类型描述}。请确认或重新选择：
- **选项**：
  1. 确认：使用「{类型名称}」进行审阅（Recommended）
  2. 使用通用规范审阅（不关联特定文档类型）
  3. {列出其他可用类型，每种作为独立选项，格式：类型名称（type_id）}

**情形 B：无法推断文档类型**

使用 `question` 工具询问：

- **标题**：选择文档类型
- **问题**：无法自动识别文档类型，请选择审阅规范：
- **选项**：
  1. 使用通用规范审阅（不关联特定文档类型）
  2. {列出所有可用类型，每种作为独立选项，格式：类型名称（type_id）——一句话描述}

记录 `doc_type`（通用则留空）。

---

#### 步骤 1.2：收集审阅重点（可选）

使用 `question` 工具询问用户是否有特定的审阅重点：

- **标题**：审阅重点
- **问题**：是否有需要重点关注的审阅维度？
- **选项**：
  1. 全面审阅（结构 + 质量 + 内容，Recommended）
  2. 重点关注结构完整性（是否符合文档类型定义）
  3. 重点关注量化质量评分
  4. 重点关注内容质量（逻辑、语言、可读性）

根据用户选择，设置 `focus_areas` 参数并调整各阶段权重。

---

#### 步骤 1.3：确认章节顺序检查模式

使用 `question` 工具询问结构审计中章节顺序的处理方式：

- **标题**：章节顺序检查
- **问题**：在结构审计中，章节顺序不符合类型定义时如何处理？
- **选项**：
  1. 标准模式：顺序偏差记录为警告（Recommended）
  2. 严格模式：顺序偏差记录为错误，等同于结构缺失

记录 `strict_mode`（默认 `false`）。

---

### 阶段 2：结构审计（doc-structure-audit）

调用 `doc-structure-audit` Skill，传入：

- `document`：阶段 0 确定的文档路径
- `doc_type`：阶段 1.1 确认的文档类型（通用规范则不传）
- `strict_mode`：阶段 1.3 确定的值

#### 审计中的提问机制

在审计过程中，遇到以下情况时，**每处不确定点均单独发起一次 `question` 工具提问**：

| 情况 | 提问方式 |
|------|---------|
| 章节标题疑似匹配（语义相近但措辞不同） | **标题**：章节匹配确认<br>**问题**：文档中的「{实际标题}」是否对应类型定义中要求的「{期望标题}」？ |
| 可选章节缺失 | **标题**：可选章节确认<br>**问题**：「{章节名}」是可选章节，当前文档未包含，是否需要在报告中标注建议添加？ |
| 内部锚点无法精确匹配 | **标题**：断链确认<br>**问题**：文档引用了锚点 `#{anchor}`，但未找到精确匹配的标题（最接近的是「{近似标题}」），是否视为断链？ |
| 重复内容可能是有意为之 | **标题**：重复内容确认<br>**问题**：第 {行A} 行和第 {行B} 行的内容高度相似，是否是有意重复（如摘要与正文的对应关系）？ |
| 章节标题完全看不出归属 | **标题**：章节归属确认<br>**问题**：文档中存在章节「{章节名}」，无法判断其对应类型定义中的哪个章节，请问这是 {候选A} 还是 {候选B}，或是自定义章节？ |
| 章节顺序偏差较大且影响评估 | **标题**：顺序偏差处理<br>**问题**：「{章节名}」出现在第 {实际位置} 位，而类型定义期望其在第 {期望位置} 位，偏差较大，请问这是文档结构的特意设计，还是排列失误？ |

收集所有回答，记录到审计上下文，作为报告的补充依据。

---

### 阶段 3：质量评分（doc-quality-score）

调用 `doc-quality-score` Skill，传入：

- `document`：文档路径
- `doc_type`：阶段 1.1 确认的文档类型

#### 评分中的提问机制

在评分过程中，遇到以下情况时，通过 `question` 工具提问：

| 情况 | 提问方式 |
|------|---------|
| 存在多处 `[假设]` / `[待确认]` / `[TBD]` 标注 | **标题**：待确认项核实<br>**问题**：文档中有 {N} 处待确认标注（如「{示例内容}」），请问这些项是否已在其他地方完成确认？若是，可提供简要说明以供参考 |
| 某章节字数异常少（< 50 字） | **标题**：章节内容确认<br>**问题**：「{章节名}」章节内容仅 {N} 字，请问该章节是有意简短（如纯引用章节），还是尚未补充完整？ |
| 无法判断文档目标受众 | **标题**：目标受众确认<br>**问题**：文档未明确说明目标受众，请问这篇文档主要写给谁看？（如：团队内部工程师 / 管理层 / 外部开发者 / 其他）——用于评估可操作性维度 |
| 数据/指标来源不明 | **标题**：数据来源确认<br>**问题**：文档中提到「{数据描述}」，请问该数据有外部来源参考，还是为内部估算？（影响信息准确性评分） |
| 代码块缺少语言标注且无法推断 | **标题**：代码语言确认<br>**问题**：文档第 {行} 行的代码块未标注语言类型，请问是什么语言？（如 `bash`、`json`、`python`） |
| 某段文字语义明显歧义 | **标题**：语义歧义确认<br>**问题**：文档中「{歧义文本}」这句话，请问是指 {解释A} 还是 {解释B}？ |

---

### 阶段 4：内容审阅（doc-review）

调用 `doc-review` Skill，传入：

- `document`：文档路径
- `doc_type`：阶段 1.1 确认的文档类型
- `focus_areas`：阶段 1.2 用户指定的审阅重点（全面审阅则不传）

#### 审阅中的提问机制

在内容审阅过程中，**遇到任何不确定之处均立即通过 `question` 工具提问，次数不设上限**：

| 情况 | 提问方式 |
|------|---------|
| 技术表述无法确认正确性 | **标题**：技术准确性确认<br>**问题**：文档中提到「{技术描述}」，我无法确认这是否准确，请问这个表述是否正确？有无参考资料？ |
| 术语在当前上下文含义不明 | **标题**：术语含义确认<br>**问题**：文档中使用了「{术语}」，在当前上下文中具体指什么？（用于判断术语一致性） |
| 两段之间存在逻辑跳跃 | **标题**：逻辑跳跃确认<br>**问题**：从「{段落A 摘要}」跳转到「{段落B 摘要}」之间，是否有未写出的中间步骤或前置条件？ |
| 结论与假设的关联不明确 | **标题**：结论依赖确认<br>**问题**：第 {章节} 中的结论「{结论}」是否依赖于假设「{假设}」？如果假设不成立，该结论是否仍然有效？ |
| 外部引用无法验证 | **标题**：引用可信度确认<br>**问题**：文档引用了「{来源描述}」，请问这是已知的可信来源，还是需要进一步核实？ |
| 同一概念使用了不同措辞 | **标题**：术语统一确认<br>**问题**：文档中「{措辞A}」（第 {行} 行）和「{措辞B}」（第 {行} 行）是否指同一概念，还是有意区分？ |
| 某处论点缺少支撑 | **标题**：论点支撑确认<br>**问题**：文档中的论点「{论点}」目前没有数据或案例支撑，请问是否有相关依据可以补充？ |
| 图表无文字说明且含义不明 | **标题**：图表含义确认<br>**问题**：文档中的图表（第 {行} 行附近）缺少文字说明，请问该图表的主要表达意图是什么？ |
| 前后数据或数字不一致 | **标题**：数据一致性确认<br>**问题**：文档中 {位置A} 提到 {数值A}，而 {位置B} 提到 {数值B}，请问哪个数据是正确的，还是两者含义不同？ |

---

### 阶段 5：综合报告汇总与写入文件

整合三个 Skill 的输出和各阶段提问收集的上下文，生成综合审阅报告，并将其写入文件。

**报告文件路径**：与被审阅文档同目录，文件名为 `{原文件名不含扩展名}.review.md`。
例如：审阅 `docs/my-design.md` → 报告写入 `docs/my-design.review.md`。

报告生成后，使用 `write` 工具将报告内容写入上述路径（若文件已存在则覆盖）。写入完成后，在对话中告知用户报告已保存的文件路径。

报告内容格式如下：

```
---

# 综合审阅报告

> **审阅文档**：`{文档路径}`
> **审阅时间**：{当前日期}
> **文档类型**：{类型名称}（`{type_id}`）或「通用」
> **审阅模式**：{全面审阅 / 重点关注 {维度}}
> **结构检查**：{标准模式 / 严格模式}

---

## 总体评价

{3-5 句话总结文档整体质量，综合三个 Skill 的发现，指出最突出的优点和最需要改进的方面。若文档质量良好，明确给出"通过"结论，不强行挑刺。}

**质量得分**：{总分}/100（{等级：优秀/良好/及格/不足/不合格}）

---

## 关键问题摘要

### 必须处理（结构错误 / P0 内容问题）

{合并 doc-structure-audit 的 ❌ 错误 + doc-review 的 P0 问题，按影响程度排序}

| # | 来源 | 位置 | 问题描述 | 修改建议 |
|---|------|------|---------|---------|
| 1 | {结构审计 / 内容审阅} | {章节/行号} | {问题} | {建议} |

> 共 {N} 个必须处理的问题。{若无：`✅ 无必须处理的问题。`}

### 重要改进（结构警告 / P1 内容问题）

{合并 doc-structure-audit 的 ⚠️ 警告 + doc-review 的 P1 问题}

| # | 来源 | 位置 | 问题描述 | 修改建议 |
|---|------|------|---------|---------|
| 1 | {来源} | {位置} | {问题} | {建议} |

> 共 {N} 个重要改进建议。

### 建议优化（结构提示 / P2 内容建议）

{合并 doc-structure-audit 的 ℹ️ 提示 + doc-review 的 P2 问题}

| # | 来源 | 位置 | 问题描述 | 修改建议 |
|---|------|------|---------|---------|
| 1 | {来源} | {位置} | {问题} | {建议} |

---

## 质量评分摘要

{引用 doc-quality-score 的总分框（含各维度分数和进度条）}

### 优先改进建议

{引用 doc-quality-score 的"优先改进建议"表，按预计提分从高到低排列}

---

## 结构审计摘要

- **结构合规率**：{N}%（{存在必需章节数}/{总必需章节数} 个必需章节）
- **断链问题**：{N} 个 / 无
- **重复内容**：{N} 处 / 无
- **主要发现**：{一句话总结}

---

## 各维度内容审阅摘要

| 审阅维度 | 状态 | 主要发现 |
|---------|:----:|---------|
| 结构完整性 | ✅ 通过 / ⚠️ 需改进 / ❌ 不通过 | {一句话说明} |
| 逻辑一致性 | ✅ / ⚠️ / ❌ | {一句话说明} |
| 语言质量 | ✅ / ⚠️ / ❌ | {一句话说明} |
| 信息准确性 | ✅ / ⚠️ / ❌ | {一句话说明} |
| 可读性 | ✅ / ⚠️ / ❌ | {一句话说明} |

---

## 优先改进路径

按影响优先级排列：

1. **立即处理**：{P0/结构错误问题的修复建议，具体可执行}
2. **近期改进**：{P1/结构警告 + 评分失分最多维度的改进建议}
3. **酌情优化**：{P2/提示类建议 + 语言打磨}

---

## 建议后续操作

- 使用 `/iterate {文档路径} <具体修改需求>` 对"必须处理"问题进行定向修复
- 使用 `/audit {文档路径}` 修复后重新运行全套检查，验证改进效果
- 使用 `doc-format-normalize` Skill 处理格式类问题

---
```

---

### 阶段 5.5：TODO 录入检查（必做，不可跳过）

审阅完成后，逐条检查以下情况是否发生：

| # | 检查项 | 是否发生 |
|---|--------|:----:|
| 1 | 审阅中发现某关联文档需要更新，但不在本次任务范围内 | 是 / 否 |
| 2 | 审阅报告中指出的问题，适合后续通过专项操作处理（如大规模重写） | 是 / 否 |
| 3 | 发现内容矛盾或信息缺失，但确认信息需要用户进一步提供 | 是 / 否 |
| 4 | 用户在对话中提到了需要后续跟进的事项，本次未处理 | 是 / 否 |
| 5 | 审阅发现的问题超出当前文档范围，涉及跨文档协调 | 是 / 否 |

**对每一条判断为"是"的项**（每项单独处理，不可合并省略）：
1. 读取 `.opencode/skills/todo-append/SKILL.md`
2. 按照 Skill 步骤将该事项追加到 `docs/TODO.md`（填写 description / source / priority / background）
3. 在完成摘要中列出已记录的 TODO 编号（如 `已记录 T-005`）

**所有项均为"否"时**：仍须在完成摘要中注明 `TODO 扫描：无项`（**此行不可省略**）。

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 文件路径不存在 | 使用 `question` 工具提示错误，请用户重新输入正确路径 |
| 提供的是绝对路径 | 使用 `question` 工具提示"请使用相对路径"，并给出转换示例 |
| 文件不是 Markdown 格式 | 使用 `question` 工具告知"本命令针对 Markdown 文档优化，格式类检查可能不准确"，询问是否仍继续 |
| 文档内容为空 | 提示"文档为空，无法进行实质性审阅"，终止流程，建议使用 `/create` 生成文档 |
| `docs/_templates/` 不存在 | 仅按通用规范审阅，在报告中注明无法进行结构合规性检查 |
| 指定类型对应模板不存在 | 使用 `question` 工具列出可用类型供重新选择，或改用通用规范 |

---

## 流程图

```
/review <文档路径>
    │
    ▼
[阶段 0] 提取文档路径
    │ 若路径为空 → question 工具询问路径
    │ 若文件不存在 → question 工具提示错误，重新询问（循环直到有效）
    ▼
[阶段 1] 了解审阅需求
    │ 1.1 推断文档类型 → question 工具确认（必做）
    │ 1.2 收集审阅重点 → question 工具询问（必做）
    │ 1.3 确认严格模式 → question 工具询问（必做）
    ▼
[阶段 2] doc-structure-audit（结构审计）
    │ 过程中遇到不确定之处 → question 工具逐一提问（每处独立提问）
    ▼
[阶段 3] doc-quality-score（质量评分）
    │ 过程中遇到不确定之处 → question 工具逐一提问
    ▼
[阶段 4] doc-review（内容审阅）
    │ 过程中遇到不确定之处 → question 工具逐一提问（次数不设上限）
    ▼
    ▼
[阶段 5] 综合报告汇总，使用 write 工具将报告写入 `{原文件名}.review.md`，并告知用户保存路径
    │
    ▼
[阶段 5.5] TODO 录入检查（必做）→ 逐条判断 5 项触发条件
    │   ├─ 有"是" → 读取 .opencode/skills/todo-append/SKILL.md → 按步骤追加 docs/TODO.md → 摘要列出编号
    │   └─ 全"否" → 摘要注明"TODO 扫描：无项"
```

---

## 注意事项

1. **路径格式**：文档路径必须为相对路径；若用户提供绝对路径，使用 `question` 工具提示并引导转换
2. **只审阅原文档，不修改原文档**：本命令不直接修改被审阅文档的内容；审阅报告会写入同目录下的 `{文件名}.review.md` 文件；若需修改原文档，引导用户使用 `/iterate` 命令
3. **提问优先**：遇到任何拿不准的地方，立即通过 `question` 工具提问，不做假设性推断；审阅准确性优先于审阅速度
4. **上下文传递**：阶段 1–4 中用户对提问的所有回答，均应在后续 Skill 调用和报告生成中作为补充上下文使用
5. **综合而非拼接**：综合报告应分析三个 Skill 发现之间的关联性，去除重叠问题，而非简单拼接三份报告
6. **正面反馈**：若文档质量良好，报告中明确给出"通过"结论，认可文档的优点，不强行挑刺
