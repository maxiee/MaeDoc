---
name: escalate
description: 一键打包当前文档上下文 + 问题，生成可直接复制给外部 AI 的中继文件，保存到 .docforge/outbox/ 目录，供用户粘贴到 Claude.ai / ChatGPT 等外部 AI 使用。
---

# /escalate 命令

> **命令**：`/escalate`
> **版本**：1.1.0
> **用途**：打包文档上下文与具体问题，生成结构化中继文件——当本地模型遇到瓶颈时，桥接到更强大的外部 AI

---

## 运行模式

本命令有两种运行模式：

| 模式 | 触发方式 | 交互方式 | 上下文范围 |
|------|---------|---------|---------|
| **手动模式**（默认） | 用户主动运行 `/escalate` | 通过 `question` 工具逐步交互，询问范围、格式等 | 以指定文档为主 |
| **自动模式** | 由 `hardness-classify` Skill 或 AI 主动求助规则触发 | 无交互，自动收集所有参数 | 更宽：含对话历史 + AI 分析过程 + 所有相关文档 |

> 若检测到当前调用来自 AI 主动触发（而非用户手动运行命令），**直接跳转到"自动模式流程"**章节，跳过阶段 0-1 的所有 `question` 交互步骤。

---

## 用法

```
/escalate <文档相对路径> <你的问题>
```

**示例**：

```
/escalate docs/my-design.md 这部分论证逻辑是否严谨？有没有遗漏的反驳视角？
/escalate docs/cap-theorem.md 请帮我找出文中论点的漏洞并提供反驳角度
/escalate docs/architecture.md 安全章节的威胁模型是否完整？有没有遗漏的攻击面？
/escalate docs/my-design.md
```

---

## 交互原则

> **重要**：所有需要向用户提问或确认的步骤，**必须使用 `question` 工具**进行交互，而非直接输出文本等待用户回复。

---

## 执行流程

### 阶段 0：获取参数

**步骤 0.1：提取命令参数**

命令参数（用户在命令后输入的内容）：`$ARGUMENTS`

从上述参数中提取：
- **文档路径**：第一个路径形式的参数（如 `docs/my-design.md`）
- **问题内容**：文档路径之后的所有内容

**步骤 0.2：若未提供文档路径，使用 `question` 工具询问**

若无法从参数中提取有效文档路径，使用 `question` 工具提问：

- **标题**：指定目标文档
- **问题**：请输入要外发的文档相对路径（如 `docs/my-design.md`）：
- **说明**：路径相对于当前工作目录，仅支持 `.md` 格式文档

**步骤 0.3：验证文件存在**

检查文件是否存在：

- 若文件**存在**：继续步骤 0.4
- 若文件**不存在**：使用 `question` 工具提示错误并请用户重新输入：
  - **标题**：文件不存在
  - **问题**：未找到文件 `{路径}`，请重新输入正确的文档路径：
  - 重复验证，直到路径有效

**步骤 0.4：若未提供问题内容，使用 `question` 工具询问**

若未从参数中提取到问题内容，使用 `question` 工具提问：

- **标题**：输入你的问题
- **问题**：你希望外部 AI 帮你解决什么问题？请尽量具体（如"检查论证逻辑是否严谨"，而非"帮我改一下"）：

---

### 阶段 1：读取文档并收集上下文

**步骤 1.1：读取目标文档**

读取文档路径对应的文件内容，记录为 `document_content`。

**步骤 1.2：生成文档摘要**

基于 `document_content`，自动生成一段简明摘要（3-5句），描述：
- 文档的主题与目的
- 文档的大致结构
- 当前文档的完成状态（草稿/完整/待补充）

记录为 `doc_summary`。

**步骤 1.3：询问外发范围**

使用 `question` 工具询问用户希望外发的内容范围：

- **标题**：选择外发内容范围
- **问题**：中继文件中包含哪些文档内容？
- **选项**：
  1. 文档全文（适合问题涉及整体结构或跨章节内容）（Recommended）
  2. 仅问题相关的章节（适合问题聚焦于某一局部）

记录 `scope`：选项 1 对应 `full`，选项 2 对应 `partial`。

若用户选择选项 2（仅相关章节），使用 `question` 工具追问：

- **标题**：指定章节范围
- **问题**：请指出问题涉及的章节标题或内容范围（可用章节标题或行号描述）：

记录为 `section_hint`，从 `document_content` 中提取对应片段作为 `relevant_content`。

**步骤 1.4：确认期望输出格式**

使用 `question` 工具询问期望回答格式：

- **标题**：期望回答格式
- **问题**：你希望外部 AI 以什么形式回答？
- **选项**：
  1. 分析报告（指出问题 + 解释原因 + 给出建议）（Recommended）
  2. 直接修改（给出修改后的文字，可直接替换）
  3. 对话讨论（更自由的探讨形式，适合思想碰撞）
  4. 其他（请在选择后说明）

记录 `expected_format`。

---

### 阶段 2：生成中继文件

**步骤 2.1：生成文件名**

根据以下规则生成 slug：
- 从问题内容中提取核心关键词（2-4个词）
- 转为英文或拼音（kebab-case）
- 长度不超过 40 字符
- 示例：「论证逻辑是否严谨」→ `argument-logic-review`；「安全威胁模型」→ `security-threat-model`

获取当前时间，格式化为 `YYYYMMDD-HHMMSS`（使用 Bash 执行 `date +%Y%m%d-%H%M%S`）。

最终文件名格式：`{YYYYMMDD-HHMMSS}-{slug}.md`

记录完整路径：`outbox_file = .docforge/outbox/{filename}.md`

**步骤 2.2：组装中继文件内容**

按以下格式组装中继文件，记录为 `relay_content`：

```markdown
# Remote AI Request

> 生成时间：{YYYYMMDD-HHMMSS}
> 源文档：{文档路径}

---

## Context

{doc_summary}

---

## Document Content

{根据 scope 选择：full → 插入 document_content 全文；partial → 插入 relevant_content}

---

## Question

{用户提出的问题内容}

---

## Expected Output

{根据 expected_format 生成对应说明：
- 分析报告：请提供一份分析报告，包含：1) 发现的问题列表（每项注明严重程度：高/中/低），2) 每个问题的原因分析，3) 具体的修改建议
- 直接修改：请直接给出修改后的文字内容，格式与原文档保持一致，可直接替换对应部分
- 对话讨论：请以开放讨论的方式分享你的看法，不需要结构化格式，重点在于深入探讨
- 其他：{用户自定义的格式说明}}
```

**步骤 2.3：写入中继文件**

确保 `.docforge/outbox/` 目录存在，将 `relay_content` 写入 `outbox_file`。

---

### 阶段 3：告知用户并给出操作指引

写入完成后，输出以下提示：

```
---

中继文件已生成！

📤 **文件路径**：`.docforge/outbox/{filename}.md`
📋 **文档**：{文档路径}
❓ **问题**：{问题内容（截断至 60 字）}

---

**下一步操作**：

1. 打开文件 `.docforge/outbox/{filename}.md`，复制全部内容
2. 粘贴到外部 AI（Claude.ai / ChatGPT / Gemini 等），发送对话
3. 将外部 AI 的回答保存为：
   `.docforge/inbox/{filename}.md`
4. 回到这里，运行命令：
   `/ingest-remote {slug}`
   引导将外部 AI 的建议应用到文档中

---

💡 **提示**：inbox 文件名需与 outbox 文件名完全一致（`{filename}.md`），以便 `/ingest-remote` 正确关联。
```

---

## 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 文件路径不存在 | 使用 `question` 工具提示错误，请用户重新输入正确路径 |
| 文档内容为空 | 提示"文档为空，无内容可外发"，建议先使用 `/create` 生成文档 |
| `.docforge/outbox/` 目录不存在 | 自动创建该目录，无需询问用户 |
| 文件写入被拒绝（权限） | 提示权限错误，建议检查 `opencode.jsonc` 的 `permission.edit` 配置 |
| 文档过长（超出合理范围） | 若选择全文模式且文档超过 10000 字，使用 `question` 工具提示，建议切换为"仅相关章节"模式 |
| date 命令执行失败 | 使用占位时间戳 `00000000-000000`，并提示用户手动重命名文件 |

---

## 流程图

```
/escalate <文档路径> <问题>
    │
    ▼
[阶段 0] 提取文档路径 + 问题内容
    │ 若路径为空 → question 工具询问 → 验证文件存在（循环直到有效）
    │ 若问题为空 → question 工具询问问题内容
    ▼
[阶段 1] 读取文档 → 生成摘要
    │ 1.3 询问外发范围（全文 / 仅相关章节）→ question 工具
    │     若选相关章节 → 追问章节范围 → 提取片段
    │ 1.4 询问期望输出格式 → question 工具
    ▼
[阶段 2] 生成文件名（时间戳 + slug）
    │ 组装中继文件（Context + Document Content + Question + Expected Output）
    │ 写入 .docforge/outbox/{filename}.md
    ▼
[阶段 3] 输出操作指引（文件路径 + 四步操作说明）
```

---

## 自动模式流程

> 本节仅适用于 AI 主动触发的场景（来自 AGENTS.md §8 主动求助规则或 `hardness-classify` Skill）。
> 手动模式请参考上方"阶段 0-3"流程。

### 自动阶段 A：收集上下文（无需用户交互）

**A.1 提取问题**
从当前对话上下文中提炼核心决策点，作为 `question`。力求精确：不要泛化为"帮我看看"，而是具体到"在 X 约束下，应该选择 A 方案还是 B 方案，原因是什么"。

**A.2 收集项目背景**
- 读取 `docs/index.md`（若存在），提取项目概览和文档树结构
- 使用 AGENTS.md §1 的项目介绍作为补充

**A.3 收集相关文档**
- 读取本次会话中已打开或与问题直接相关的所有文档
- 若尚未读取相关文档，根据问题内容判断并主动读取（最多 3 个最相关的）
- 记录每个文档的路径和全文内容，供后续内联到上报包

**A.4 整理 AI 分析过程**
记录以下内容：
- 已从哪些角度分析了问题
- 考虑过哪些方案（各自的初步印象）
- 具体卡在哪里（是信息不足？方案博弈？专业知识缺口？）
- 如果强行给答案，最大的不确定性在哪里

**A.5 提取已知约束**
从对话上下文中提取：用户明确说过的技术限制、排除的方案、偏好、项目规范要求。

### 自动阶段 B：组装上报包

生成文件名（同手动模式：时间戳 + slug），组装以下内容：

```markdown
# Remote AI Request（主动上报）

> 生成时间：{YYYYMMDD-HHMMSS}
> 触发方式：AI 主动求助（hardness-classify 评估超出独立处理阈值）

---

## 项目背景

**项目**：MaeDoc — 基于 Open Code + Skills 的通用文档 AI Agent 生成器

{从 docs/index.md + AGENTS.md §1 提取的 3-5 句项目简介}

**文档树**：
{docs/index.md 中的文档结构，或列出 docs/ 主要子目录}

---

## 当前任务

{用户在本次会话中的目标，以及当前处于哪个阶段}

---

## 具体问题

{精确的决策点描述。不要问"这样好不好"，而是"在 X 条件下，选择 A 还是 B，各自的权衡是什么？推荐哪个？"}

---

## 相关文档内容

{对每个相关文档，直接内联完整内容：}

### {文档标题}（路径：{文档路径}）

{文档全文}

---

## AI 的分析过程

**已考虑的角度**：
{bullet list}

**各方案初步分析**：
{如果有多个方案，列出每个方案的初步判断}

**卡住的原因**：
{具体说明无法独立解决的核心障碍}

---

## 已知约束

{用户明确提到的限制、排除项、偏好}

---

## 期望输出

请提供一份**决策分析报告**：

1. **确认问题理解**：用你自己的话重述核心决策点，确保没有误解
2. **方案权衡**：对各方案进行结构化分析（适用场景 / 优势 / 劣势 / 风险）
3. **明确推荐**：给出你的推荐方案，以及推理依据（请直接说"推荐 X，因为..."）
4. **风险提示**：推荐方案的主要风险和需关注的前提条件
5. **后续步骤**：如果采纳推荐，接下来应该做什么

请避免"这取决于具体情况"式的模糊回答。如果信息不足，请明确说明还需要哪些信息才能给出判断。
```

### 自动阶段 C：写入并告知

写入 `.docforge/outbox/{filename}.md`，然后输出：

```
这个问题超出了我能独立给出高置信答案的范围。
已自动生成外部求助包：`.docforge/outbox/{filename}.md`

**下一步**：
1. 打开该文件，复制全部内容
2. 粘贴到 Claude.ai / ChatGPT 等外部 AI，发送
3. 将外部 AI 的回答保存为 `.docforge/inbox/{filename}.md`
4. 运行 `/ingest-remote {slug}` 将建议应用到文档
```

---

## 注意事项

1. **不自动外发**：本命令只生成本地文件，不自动发送任何网络请求，用户全程掌控数据去向
2. **文件名一致性**：outbox 和 inbox 文件名必须完全一致，`/ingest-remote` 依赖此对应关系
3. **问题要具体**：中继文件的价值取决于问题质量；若问题过于模糊，外部 AI 无法给出有价值的回答
4. **敏感信息提示**：若文档中包含 API Key、密码、邮箱等敏感信息，外发前请手动检查并替换为占位符
5. **inbox 保存规范**：将外部 AI 回答保存到 inbox 时，建议保留回答的完整原文，`/ingest-remote` 会引导选择性采纳
6. **自动模式上下文更完整**：自动触发时，上报包会包含对话历史和 AI 分析过程，外部 AI 能获得比手动模式更充分的背景信息
